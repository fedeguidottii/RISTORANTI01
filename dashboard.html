<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Dashboard Ristorante</title>
    <script>
        if (localStorage.getItem('dashboardAuthToken') !== 'authenticated') {
            const currentUrl = window.location.href;
            const newUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/')) + '/login.html';
            window.location.href = newUrl;
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/it.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-cream-bg">
    <!-- Floating orb for additional visual effect -->
    <div class="floating-orb"></div>
    
    <audio id="notification-sound" preload="auto" src="https://cdn.freesound.org/previews/219/219476_4112349-lq.mp3"></audio>
    <div class="relative min-h-screen md:flex">
        <div class="fixed inset-0 bg-black/60 z-20 md:hidden hidden" id="sidebar-overlay"></div>
        <aside class="bg-[var(--sidebar-bg)] border-r border-[var(--border-color)] text-[var(--text-dark)] w-64 fixed inset-y-0 left-0 h-screen transform -translate-x-full md:translate-x-0 transition duration-200 ease-in-out z-30 flex flex-col shadow-lg" id="sidebar" style="position: fixed; top: 0; bottom: 0; overflow-y: auto;">
            <div class="p-4 pt-7 border-b border-[var(--border-color)] flex items-center justify-center gap-3 flex-shrink-0" id="header-content">
                <h1 class="text-xl font-semibold text-[var(--text-dark)]" style="font-family: 'Playfair Display', serif;">Dashboard</h1>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <a class="nav-link active flex items-center gap-2" data-view="ordini" href="#">Ordini</a>
                <a class="nav-link flex items-center gap-2" data-view="tavoli" href="#">Tavoli</a>
                <a class="nav-link flex items-center gap-2" data-view="prenotazioni" href="#">Prenotazioni</a>
                <a class="nav-link flex items-center gap-2" data-view="menu" href="#">Menù</a>
                <a class="nav-link flex items-center gap-2" data-view="analitiche" href="#">Analitiche</a>
            </nav>
            <div class="p-4 pb-12 space-y-2 border-t border-gray-200 flex-shrink-0">
                <a class="nav-link flex items-center gap-2" data-view="impostazioni" href="#">Impostazioni</a>
                <button class="w-full text-left text-red-600 font-medium p-2 rounded-lg hover:bg-red-50 flex items-center gap-2 transition" onclick="window.logout()">
                    <svg class="h-5 w-5" fill="currentColor" viewbox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path clip-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" fill-rule="evenodd"></path></svg>
                    Logout
                </button>
            </div>
        </aside>
        <div class="flex-1 flex flex-col md:ml-64">
            <header class="p-4 md:hidden flex justify-start items-center bg-white border-b border-gray-200 sticky top-0 z-10">
                <button class="text-gray-600" id="mobile-menu-button">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 6h16M4 12h16M4 18h16" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                    </svg>
                </button>
                <div class="flex-1 text-center font-semibold text-lg text-gray-800" style="font-family: 'Playfair Display', serif;" id="mobile-header-content"></div>
            </header>
            <main class="flex-1 p-4 md:p-6 lg:p-8 overflow-y-auto">
                <section class="view-section active" id="ordini">
                    <div class="mb-6 flex justify-center">
                        <div class="flex items-center gap-1 bg-gray-100 p-1 rounded-lg">
                            <button id="view-by-tables" class="tab-btn active px-6 py-2">Tavoli</button>
                            <button id="view-by-dishes" class="tab-btn px-6 py-2">Piatti</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-gray-800" style="font-family: 'Poppins', sans-serif;">Ordini in Arrivo</h2>
                            </div>
                            <div class="text-center py-10" id="loading-state-active"><p class="text-gray-600">In attesa di nuovi ordini...</p></div>
                            <div class="space-y-4" id="orders-feed-active"></div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-gray-800" style="font-family: 'Poppins', sans-serif;">Ordini Completati</h2>
                            </div>
                            <div class="text-center py-10" id="loading-state-completed"><p class="text-gray-600">Nessun ordine completato.</p></div>
                            <div class="space-y-3" id="orders-feed-completed"></div>
                        </div>
                    </div>
                </section>
                <section class="view-section" id="tavoli">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6" style="font-family: 'Poppins', sans-serif;">Gestione Tavoli</h2>
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">Gestione Tavoli</h3>
                        <button onclick="window.openAddTableModal()" class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-medium py-2.5 px-4 rounded-lg hover:from-emerald-600 hover:to-emerald-700 transition-all duration-200 shadow-sm">
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Aggiungi Tavolo
                        </button>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Lista Tavoli</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5" id="tables-grid"></div>
                    </div>
                </section>
                <section class="view-section" id="prenotazioni">
                    <div class="flex flex-col space-y-4 sm:space-y-0 sm:flex-row sm:justify-between sm:items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800" style="font-family: 'Poppins', sans-serif;">Gestione Prenotazioni</h2>
                        <button class="btn-accent text-white font-semibold py-2 px-5 rounded-lg hover:opacity-90 transition-opacity whitespace-nowrap w-full sm:w-auto" onclick="window.openEditReservationModal()">+ Nuova Prenotazione</button>
                    </div>

                    <div>
                        <div class="glass-card p-4 mb-6">
                            <div class="flex items-center justify-between gap-2">
                                <div class="flex items-center gap-2 bg-gray-100 p-1 rounded-lg">
                                    <button id="timeline-today-btn" class="tab-btn px-4 py-2 rounded-md text-sm font-medium">Oggi</button>
                                    <button id="timeline-tomorrow-btn" class="tab-btn px-4 py-2 rounded-md text-sm font-medium">Domani</button>
                                    <button id="timeline-third-day-btn" class="tab-btn px-4 py-2 rounded-md text-sm font-medium"></button>
                                </div>
                                <input type="text" id="timeline-date-picker" class="glass-input text-center font-semibold text-lg w-48">
                                <div>
                                    <button id="timeline-prev-day" class="font-semibold text-xl p-2 hover:bg-gray-100 rounded-full text-gray-600">‹</button>
                                    <button id="timeline-next-day" class="font-semibold text-xl p-2 hover:bg-gray-100 rounded-full text-gray-600">›</button>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-x-auto bg-gray-50 p-2 rounded-lg border">
                            <div id="timeline-container" class="min-w-[1200px]"></div>
                        </div>
                    </div>

                    <div class="mt-8">
                        <div class="flex justify-between items-center mb-4 border-b border-gray-200">
                             <h3 class="text-xl font-bold text-gray-800" style="font-family: 'Poppins', sans-serif;">Elenco</h3>
                             <div class="flex items-center gap-1 bg-gray-100 p-1 rounded-lg">
                                <button id="tab-future" class="tab-btn active">Future</button>
                                <button id="tab-past" class="tab-btn">Passate</button>
                            </div>
                        </div>
                        <div id="reservations-list-container" class="space-y-3">
                        </div>
                    </div>
                </section>
                <section class="view-section" id="menu">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6" style="font-family: 'Poppins', sans-serif;">Gestione Menù</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <div class="glass-card p-6 mb-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-800">Lista Piatti</h3>
                                    <input type="text" id="menu-search" placeholder="Cerca piatto..." class="glass-input px-3 py-2 w-64">
                                </div>
                                <div id="menu-list" class="space-y-4"></div>
                            </div>
                        </div>
                        <div class="lg:col-span-1 space-y-6">
                            <div class="glass-card p-6 h-fit">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Aggiungi Piatto</h3>
                                <form class="space-y-4" id="add-dish-form">
                                    <input class="w-full px-4 py-2 glass-input" name="name" placeholder="Nome Piatto" required="" type="text"/>
                                    <textarea class="w-full px-4 py-2 glass-input" name="description" placeholder="Descrizione" rows="3"></textarea>
                                    <input class="w-full px-4 py-2 glass-input" name="price" placeholder="Prezzo (es. 9.50)" required="" step="0.01" type="number"/>
                                    <select class="w-full px-4 py-2 glass-select" id="dish-category" name="category" required=""></select>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Allergeni</label>
                                        <input class="w-full mt-1 px-4 py-2 glass-input" name="allergens" placeholder="Glutine, Lattosio, Soia" type="text"/>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Foto (Opzionale)</label>
                                        <input accept="image/png, image/jpeg, image/webp" class="w-full text-sm mt-1 text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100" name="photo" type="file"/>
                                    </div>
                                    <div class="flex items-center" id="add-extra-charge-container">
                                        <input class="h-4 w-4 text-gold-accent bg-gray-100 border-gray-300 rounded focus:ring-gold-accent" id="add-is-extra-charge" name="isExtraCharge" type="checkbox" value="true"/>
                                        <label class="ml-2 block text-sm text-gray-700" for="add-is-extra-charge">Extra in modalità AYCE</label>
                                    </div>
                                    <button class="w-full btn-primary font-bold py-2.5 px-4 rounded-lg hover:opacity-90 transition-opacity disabled:bg-gray-400" type="submit">Aggiungi Piatto</button>
                                </form>
                            </div>
                            <div class="glass-card p-6 h-fit">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Gestisci Categorie</h3>
                                <div class="mb-4">
                                    <div class="flex gap-2 mb-3">
                                        <input class="flex-1 w-full px-4 py-2 glass-input" id="new-category-name" placeholder="Nome nuova categoria" type="text"/>
                                        <button class="btn-accent text-white font-bold px-4 py-2 rounded-lg hover:opacity-90 transition-opacity" onclick="window.addCategory()">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </button>
                                    </div>

                                </div>
                                <div class="space-y-2 max-h-60 overflow-y-auto" id="category-list"></div>
                            </div>
                        </div>
                    </div>
                </section>
                <section class="view-section" id="impostazioni">
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2" style="font-family: 'Playfair Display', serif;">Impostazioni</h2>
                        <p class="text-gray-600">Configura il tuo ristorante e personalizza l'esperienza</p>
                    </div>
                    
                    <!-- Settings Categories Tabs -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="flex space-x-8" aria-label="Tabs">
                            <button class="settings-tab active text-[var(--gold-accent)] border-b-2 border-[var(--gold-accent)] font-medium text-sm py-2 px-1 transition-all" data-tab="generale">
                                Generale
                            </button>
                            <button class="settings-tab text-gray-500 hover:text-gray-700 font-medium text-sm py-2 px-1 transition-all" data-tab="servizio">
                                Servizio
                            </button>
                            <button class="settings-tab text-gray-500 hover:text-gray-700 font-medium text-sm py-2 px-1 transition-all" data-tab="prenotazioni">
                                Prenotazioni
                            </button>
                            <button class="settings-tab text-gray-500 hover:text-gray-700 font-medium text-sm py-2 px-1 transition-all" data-tab="pagamenti">
                                Pagamenti
                            </button>
                        </nav>
                    </div>
                    
                    <div class="max-w-4xl mx-auto">
                        <!-- Generale Tab Content -->
                        <div class="settings-panel active" id="generale-panel">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Restaurant Info Card -->
                                <div class="glass-card p-5">
                                    <div class="flex items-center gap-2 mb-4">
                                        <div class="w-8 h-8 bg-[var(--gold-accent)] bg-opacity-10 rounded-lg flex items-center justify-center">
                                            <svg class="w-4 h-4 text-[var(--gold-accent)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                            </svg>
                                        </div>
                                        <h3 class="text-base font-semibold text-gray-800">Informazioni</h3>
                                    </div>
                                    <form class="space-y-3" id="details-form">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600 mb-1" for="details-name">Nome Ristorante</label>
                                            <input class="w-full px-3 py-2 text-sm glass-input" id="details-name" name="nomeRistorante" type="text" placeholder="Il tuo ristorante"/>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600 mb-1" for="details-logo">Logo</label>
                                            <div class="flex items-center gap-3">
                                                <div class="flex-shrink-0 w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                                                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                    </svg>
                                                </div>
                                                <div class="flex-1">
                                                    <input accept="image/png, image/jpeg, image/webp" class="w-full text-xs text-gray-500 file:mr-2 file:py-1.5 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-medium file:bg-[var(--gold-accent)] file:bg-opacity-10 file:text-[var(--gold-accent)] hover:file:bg-opacity-20 cursor-pointer" id="details-logo" name="logo" type="file"/>
                                                    <p class="text-xs text-gray-500 mt-0.5">Max 2MB</p>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="w-full bg-[var(--gold-accent)] text-white font-medium py-2 px-4 rounded-lg hover:opacity-90 transition-opacity text-sm mt-3" type="submit">Salva</button>
                                    </form>
                                </div>
                                
                                <!-- Appearance Card -->
                                <div class="glass-card p-5">
                                    <div class="flex items-center gap-2 mb-4">
                                        <div class="w-8 h-8 bg-[var(--gold-accent)] bg-opacity-10 rounded-lg flex items-center justify-center">
                                            <svg class="w-4 h-4 text-[var(--gold-accent)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                                            </svg>
                                        </div>
                                        <h3 class="text-base font-semibold text-gray-800">Aspetto</h3>
                                    </div>
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-3">
                                                <div class="w-10 h-10 bg-gray-900 rounded-lg flex items-center justify-center">
                                                    <svg class="w-5 h-5 text-[var(--gold-accent)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <h4 class="text-sm font-medium text-gray-800">Modalità Scura</h4>
                                                    <p class="text-xs text-gray-600">Tema elegante con accenti dorati</p>
                                                </div>
                                            </div>
                                            <label class="switch">
                                                <input id="dark-mode-toggle" type="checkbox"/>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-3">Applicato a tutti i siti del ristorante</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Servizio Tab Content -->
                        <div class="settings-panel hidden" id="servizio-panel">
                            <div class="max-w-2xl mx-auto">
                                <!-- Waiter Mode Card -->
                                <div class="glass-card p-5">
                                    <div class="flex items-center gap-2 mb-4">
                                        <div class="w-8 h-8 bg-[var(--gold-accent)] bg-opacity-10 rounded-lg flex items-center justify-center">
                                            <svg class="w-4 h-4 text-[var(--gold-accent)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                            </svg>
                                        </div>
                                        <h3 class="text-base font-semibold text-gray-800">Modalità Cameriere</h3>
                                    </div>
                                    <div class="bg-gray-50 rounded-lg p-3 mb-4">
                                        <div class="flex items-center justify-between">
                                            <div class="flex-1 pr-3">
                                                <h4 class="text-sm font-medium text-gray-800">Abilita Accesso Camerieri</h4>
                                                <p class="text-xs text-gray-600 mt-0.5">Interfaccia semplificata per il personale</p>
                                            </div>
                                            <label class="switch">
                                                <input id="waiter-mode-toggle" type="checkbox"/>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="hidden" id="waiter-mode-options">
                                        <form class="grid grid-cols-1 md:grid-cols-2 gap-3" id="waiter-credentials-form">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-600 mb-1" for="waiter-username">Username</label>
                                                <input class="w-full px-3 py-2 text-sm glass-input" id="waiter-username" type="text" placeholder="username_cameriere"/>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-600 mb-1" for="waiter-password">Password</label>
                                                <input class="w-full px-3 py-2 text-sm glass-input" id="waiter-password" placeholder="Lascia vuoto per non cambiare" type="password"/>
                                            </div>
                                            <div class="md:col-span-2">
                                                <button class="w-full bg-[var(--gold-accent)] text-white font-medium py-2 px-4 rounded-lg hover:opacity-90 transition-opacity text-sm" type="submit">Aggiorna Credenziali</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pagamenti Tab Content -->
                        <div class="settings-panel hidden" id="pagamenti-panel">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- All You Can Eat Card -->
                                <div class="glass-card p-5">
                                    <div class="flex items-center gap-2 mb-4">
                                        <div class="w-8 h-8 bg-[var(--gold-accent)] bg-opacity-10 rounded-lg flex items-center justify-center">
                                            <svg class="w-4 h-4 text-[var(--gold-accent)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path>
                                            </svg>
                                        </div>
                                        <h3 class="text-base font-semibold text-gray-800">All You Can Eat</h3>
                                    </div>
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <div class="flex items-center justify-between mb-3">
                                            <div>
                                                <h4 class="text-sm font-medium text-gray-800">Formula AYCE</h4>
                                                <p class="text-xs text-gray-600">Prezzo fisso per persona</p>
                                            </div>
                                            <label class="switch">
                                                <input id="ayce-toggle" type="checkbox"/>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="hidden space-y-3" id="ayce-options-container">
                                            <div class="pt-3 border-t border-gray-200">
                                                <label class="block text-xs font-medium text-gray-600 mb-1" for="ayce-price">Prezzo per persona</label>
                                                <div class="relative">
                                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">€</span>
                                                    <input class="w-full pl-8 pr-3 py-2 text-sm glass-input" id="ayce-price" placeholder="25.90" step="0.10" type="number"/>
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <label class="text-xs font-medium text-gray-700" for="ayce-limit-orders-toggle">Limita ordinazioni</label>
                                                <label class="switch small">
                                                    <input id="ayce-limit-orders-toggle" type="checkbox"/>
                                                    <span class="slider"></span>
                                                </label>
                                            </div>
                                            <div class="hidden" id="ayce-max-orders-container">
                                                <input class="w-full px-3 py-2 text-sm glass-input" id="ayce-max-orders" min="1" placeholder="Max ordinazioni" type="number"/>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Coperto Card -->
                                <div class="glass-card p-5">
                                    <div class="flex items-center gap-2 mb-4">
                                        <div class="w-8 h-8 bg-[var(--gold-accent)] bg-opacity-10 rounded-lg flex items-center justify-center">
                                            <svg class="w-4 h-4 text-[var(--gold-accent)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                            </svg>
                                        </div>
                                        <h3 class="text-base font-semibold text-gray-800">Coperto</h3>
                                    </div>
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <div class="flex items-center justify-between mb-3">
                                            <div>
                                                <h4 class="text-sm font-medium text-gray-800">Servizio Coperto</h4>
                                                <p class="text-xs text-gray-600">Costo fisso per persona</p>
                                            </div>
                                            <label class="switch">
                                                <input id="coperto-toggle" type="checkbox"/>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="hidden" id="coperto-price-container">
                                            <div class="pt-3 border-t border-gray-200">
                                                <label class="block text-xs font-medium text-gray-600 mb-1" for="coperto-price">Prezzo coperto</label>
                                                <div class="relative">
                                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">€</span>
                                                    <input class="w-full pl-8 pr-3 py-2 text-sm glass-input" id="coperto-price" placeholder="2.00" step="0.10" type="number"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Prenotazioni Tab Content -->
                        <div class="settings-panel hidden" id="prenotazioni-panel">
                            <div class="max-w-3xl mx-auto">
                                <div class="glass-card p-5">
                                    <div class="flex items-center gap-2 mb-4">
                                        <div class="w-8 h-8 bg-[var(--gold-accent)] bg-opacity-10 rounded-lg flex items-center justify-center">
                                            <svg class="w-4 h-4 text-[var(--gold-accent)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>
                                        </div>
                                        <h3 class="text-base font-semibold text-gray-800">Configurazione Prenotazioni</h3>
                                    </div>
                                    <div class="space-y-4">
                                        <!-- Orari Section -->
                                        <div class="bg-gray-50 rounded-lg p-3 mb-4">
                                            <h4 class="text-sm font-medium text-gray-800 mb-3">Orari di Servizio</h4>
                                            <div class="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label class="block text-xs font-medium text-gray-600 mb-1" for="timeline-start-hour">Apertura</label>
                                                    <select class="w-full px-3 py-2 text-sm glass-select" id="timeline-start-hour">
                                                        <option value="8">08:00</option>
                                                        <option value="9">09:00</option>
                                                        <option value="10">10:00</option>
                                                        <option value="11" selected>11:00</option>
                                                        <option value="12">12:00</option>
                                                        <option value="13">13:00</option>
                                                        <option value="14">14:00</option>
                                                        <option value="15">15:00</option>
                                                        <option value="16">16:00</option>
                                                        <option value="17">17:00</option>
                                                        <option value="18">18:00</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-medium text-gray-600 mb-1" for="timeline-end-hour">Chiusura</label>
                                                    <select class="w-full px-3 py-2 text-sm glass-select" id="timeline-end-hour">
                                                        <option value="20">20:00</option>
                                                        <option value="21">21:00</option>
                                                        <option value="22">22:00</option>
                                                        <option value="23">23:00</option>
                                                        <option value="24">00:00</option>
                                                        <option value="25" selected>01:00</option>
                                                        <option value="26">02:00</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Durata Cena -->
                                        <div class="bg-gray-50 rounded-lg p-3 mb-4">
                                            <label class="block text-sm font-medium text-gray-800 mb-2" for="dinner-duration">Durata cena standard</label>
                                            <div class="flex items-center gap-3">
                                                <input class="flex-1 px-3 py-2 text-sm glass-input" id="dinner-duration" placeholder="90" type="number" min="30" max="300" step="15"/>
                                                <span class="text-sm text-gray-600">minuti</span>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-2">Tempo medio per calcolare le prenotazioni</p>
                                        </div>
                                        
                                        <!-- Notifiche -->
                                        <div class="bg-gray-50 rounded-lg p-3">
                                            <div class="flex items-center justify-between mb-3">
                                                <div>
                                                    <h4 class="text-sm font-medium text-gray-800">Notifiche Prenotazioni</h4>
                                                    <p class="text-xs text-gray-600">Avvisi per prenotazioni in arrivo</p>
                                                </div>
                                                <label class="switch">
                                                    <input id="reservation-notifications-toggle" type="checkbox"/>
                                                    <span class="slider"></span>
                                                </label>
                                            </div>
                                            <div class="hidden" id="reservation-notifications-options">
                                                <label class="block text-xs font-medium text-gray-600 mb-1" for="notification-minutes">Preavviso</label>
                                                <select class="w-full px-3 py-2 text-sm glass-select" id="notification-minutes">
                                                    <option value="15">15 minuti</option>
                                                    <option value="30" selected>30 minuti</option>
                                                    <option value="45">45 minuti</option>
                                                    <option value="60">60 minuti</option>
                                                </select>
                                            </div>
                                        </div>
                            </div>
                        </div>
                    </div>
                </section>
                <section class="view-section" id="analitiche">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold text-gray-800" style="font-family: 'Playfair Display', serif;">Analitiche</h2>
                        <div class="flex flex-wrap items-center gap-2">
                            <div class="flex items-center gap-1 bg-gray-100 p-1 rounded-lg">
                                <button id="filter-today" class="tab-btn" data-days="0">Oggi</button>
                                <button id="filter-yesterday" class="tab-btn" data-days="1">Ieri</button>
                                <button id="filter-7days" class="tab-btn" data-days="7">7 giorni</button>
                                <button id="filter-30days" class="tab-btn" data-days="30">30 giorni</button>
                                <button id="filter-90days" class="tab-btn" data-days="90">90 giorni</button>
                            </div>
                            <div class="flex items-center gap-2 glass-card p-2">
                                <input class="glass-input text-sm p-2" id="start-date" type="date"/>
                                <span class="text-gray-500">-</span>
                                <input class="glass-input text-sm p-2" id="end-date" type="date"/>
                                <button class="btn-accent text-white font-semibold py-2 px-3 rounded-md text-sm" onclick="window.applyCustomDateFilter()">Applica</button>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="glass-card p-5"><p class="text-sm text-gray-600">Incasso Totale</p><p class="text-3xl font-bold text-green-600" id="total-revenue">€0.00</p></div>
                        <div class="glass-card p-5"><p class="text-sm text-gray-600">Totale Conti Pagati</p><p class="text-3xl font-bold text-blue-600" id="total-orders-count">0</p></div>
                    </div>
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                        <div class="glass-card p-6">
                            <h3 class="font-semibold mb-4 text-gray-800">Andamento Incassi</h3>
                            <div class="relative h-80"><canvas id="revenueChart"></canvas></div>
                        </div>
                        <div class="glass-card p-6">
                            <h3 class="font-semibold mb-4 text-gray-800">Numero Conti per Giorno</h3>
                            <div class="relative h-80"><canvas id="ordersChart"></canvas></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 mt-8">
                        <div class="glass-card p-6">
                            <h3 class="font-semibold mb-4 text-gray-800">Top 10 Piatti più Ordinati</h3>
                            <div class="mb-4">
                                <p class="text-sm text-gray-600 mb-2">Filtra per categorie:</p>
                                <div class="flex flex-wrap gap-2" id="category-toggles"></div>
                            </div>
                            <div class="relative" style="height: 500px; max-width: 600px; margin: 0 auto;">
                                <canvas id="dishesPieChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>
    <div class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50" id="reservation-modal">
        <div class="glass-card max-w-lg w-full p-6 relative">
            <button class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 text-2xl font-bold" onclick="document.getElementById('reservation-modal').classList.add('hidden')">&times;</button>
            <h3 id="reservation-modal-title" class="text-2xl font-bold mb-4 text-gray-800" style="font-family: 'Playfair Display', serif;">Crea Prenotazione</h3>
            <form id="add-reservation-form-modal" class="space-y-4">
                <input type="hidden" id="reservation-form-id">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="customerName-modal" class="block text-sm font-medium text-gray-700 mb-1">Nome Cliente*</label>
                        <input type="text" id="customerName-modal" name="customerName" class="w-full px-4 py-2 glass-input" required>
                    </div>
                    <div>
                        <label for="partySize-modal" class="block text-sm font-medium text-gray-700 mb-1">N. Persone*</label>
                        <input type="number" id="partySize-modal" name="partySize" class="w-full px-4 py-2 glass-input" required min="1">
                    </div>
                    <div>
                        <label for="customerPhone-modal" class="block text-sm font-medium text-gray-700 mb-1">Telefono</label>
                        <input type="tel" id="customerPhone-modal" name="customerPhone" class="w-full px-4 py-2 glass-input">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                    <div>
                        <label for="reservationDate-modal" class="block text-sm font-medium text-gray-700 mb-1">Data*</label>
                        <input type="text" id="reservationDate-modal" name="reservationDate" class="w-full px-4 py-2" placeholder="Seleziona data..." required>
                    </div>
                    <div>
                        <label for="reservationTime-modal" class="block text-sm font-medium text-gray-700 mb-1">Ora*</label>
                        <input type="text" id="reservationTime-modal" name="reservationTime" class="w-full px-4 py-2" placeholder="Seleziona ora..." required>
                    </div>
                </div>
                <div>
                    <label for="dinnerDuration-modal" class="block text-sm font-medium text-gray-700 mb-1">Durata cena (minuti)</label>
                    <input type="number" id="dinnerDuration-modal" name="dinnerDuration" class="w-full px-4 py-2 glass-input" min="30" max="300" step="15" placeholder="90">
                    <p class="text-xs text-gray-500 mt-1">Durata prevista della cena per calcolare l'occupazione del tavolo</p>
                </div>
                <div>
                    <label for="reservationTable-modal" class="block text-sm font-medium text-gray-700 mb-1">Tavolo (Opzionale)</label>
                    <select id="reservationTable-modal" name="reservationTable" class="w-full px-4 py-2 glass-select"></select>
                </div>
                <button type="submit" id="reservation-form-submit-btn" class="w-full btn-primary font-bold py-2.5 px-4 rounded-lg hover:opacity-90 transition-opacity">Salva Prenotazione</button>
            </form>
        </div>
    </div>
    <div class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50" id="check-in-modal">
        <div class="glass-card max-w-sm w-full p-8 text-center relative">
             <button class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 text-2xl font-bold" onclick="document.getElementById('check-in-modal').classList.add('hidden')">&times;</button>
            <h3 class="text-2xl font-semibold mb-2 text-gold-accent" style="font-family: 'Playfair Display', serif;">Check-in Effettuato</h3>
            <p class="text-gray-700 mb-4 font-medium" id="check-in-customer-name"></p>
            <p class="text-gray-600">Il tavolo <strong id="check-in-table-name" class="text-gray-800"></strong> è stato attivato.</p>
            <p class="text-gray-600 mb-6">Comunica il seguente PIN al cliente:</p>
            <div class="bg-gray-100 border-2 border-gold-accent rounded-lg py-4">
                <p class="text-5xl font-bold tracking-widest text-gold-accent" id="check-in-pin"></p>
            </div>
             <button class="mt-6 w-full btn-accent text-white font-semibold py-3 px-4 rounded-lg hover:opacity-90 transition" onclick="document.getElementById('check-in-modal').classList.add('hidden')">Chiudi</button>
        </div>
    </div>
    <div class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50" id="edit-dish-modal">
        <div class="glass-card max-w-md w-full p-6 relative">
            <button class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 text-2xl font-bold" onclick="document.getElementById
            <h3 class="text-2xl font-semibold mb-4 text-gray-800" style="font-family: 'Playfair Display', serif;">Modifica Piatto</h3>
            <form class="space-y-4" id="edit-dish-form">
                <input name="dishId" type="hidden"/>
                <input class="w-full px-4 py-2 glass-input" name="name" placeholder="Nome Piatto" required="" type="text"/>
                <textarea class="w-full px-4 py-2 glass-input" name="description" placeholder="Descrizione" rows="3"></textarea>
                <input class="w-full px-4 py-2 glass-input" name="price" placeholder="Prezzo" required="" step="0.01" type="number"/>
                <select class="w-full px-4 py-2 glass-select" id="edit-dish-category" name="category" required=""></select>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Allergeni</label>
                    <input class="w-full mt-1 px-4 py-2 glass-input" name="allergens" placeholder="Glutine, Lattosio" type="text"/>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Cambia Foto</label>
                    <input accept="image/png, image/jpeg, image/webp" class="w-full text-sm mt-1 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gold-accent/20 file:text-gold-accent hover:file:bg-gold-accent/30" name="photo" type="file"/>
                </div>
                <div class="flex items-center" id="edit-extra-charge-container">
                    <input class="h-4 w-4 text-gold-accent bg-gray-100 border-gray-300 rounded focus:ring-gold-accent" id="edit-is-extra-charge" name="isExtraCharge" type="checkbox" value="true"/>
                    <label class="ml-2 block text-sm text-gray-700" for="edit-is-extra-charge">Extra in modalità AYCE</label>
                </div>
                <button class="w-full btn-success font-bold py-2.5 px-4 rounded-lg hover:opacity-90" type="submit">Salva Modifiche</button>
            </form>
        </div>
    </div>
    <div class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50" id="qr-code-modal">
        <div class="glass-card max-w-sm w-full p-6 text-center relative">
            <button class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 text-2xl font-bold" onclick="document.getElementById('qr-code-modal').classList.add('hidden')">×</button>
            <h3 class="text-2xl font-bold mb-4" id="qr-modal-title">QR Code</h3>
            <div class="flex justify-center items-center p-4 bg-white rounded-lg" id="qr-code-container"></div>
            <a class="mt-4 inline-block w-full btn-accent font-bold py-2 px-4 rounded-lg hover:opacity-90" download="qr-code.png" href="#" id="qr-download-link">Scarica QR Code</a>
        </div>
    </div>
    <div class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50" id="bill-details-modal">
        <div class="glass-card max-w-lg w-full p-6 relative">
            <button class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 text-2xl font-bold" onclick="document.getElementById('bill-details-modal').classList.add('hidden')">×</button>
            <h3 class="text-2xl font-bold mb-4" id="bill-modal-title">Dettaglio Conto</h3>
            <div class="space-y-2 max-h-[60vh] overflow-y-auto p-2" id="bill-modal-content"></div>
            <div class="mt-6 pt-4 border-t border-gray-200 text-right" id="bill-modal-total">
                <p class="text-2xl font-bold">Totale: <span class="text-green-500" id="bill-total-amount"></span></p>
            </div>
            <!-- Gestione Conto - Table Management Actions -->
            <div class="mt-6 pt-4 border-t border-gray-200" id="bill-management-actions">
                <h4 class="text-lg font-semibold mb-3 text-gray-700">Gestione Conto</h4>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="window.closeBillAndSession(false)" class="bg-gradient-to-r from-red-500 to-red-600 text-white font-medium py-2.5 px-3 rounded-lg hover:from-red-600 hover:to-red-700 transition-all duration-200 shadow-sm">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Svuota
                    </button>
                    <button onclick="window.closeBillAndSession(true)" class="bg-gradient-to-r from-green-500 to-green-600 text-white font-medium py-2.5 px-3 rounded-lg hover:from-green-600 hover:to-green-700 transition-all duration-200 shadow-sm">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Pagato
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="hidden fixed bottom-10 right-10 glass-card px-6 py-3 rounded-full shadow-lg z-50 font-semibold" id="toast-notification"></div>

    <script type="module">
        import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, deleteDoc, updateDoc, query, orderBy, where, setDoc, serverTimestamp, getDoc, writeBatch, runTransaction, getDocs, arrayRemove, arrayUnion, increment, connectFirestoreEmulator, enableNetwork, disableNetwork } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDZlTROHoRLrA4CBJ8H8158EuGFT5uPULc",
          authDomain: "ristorante-a6740.firebaseapp.com",
          projectId: "ristorante-a6740",
          storageBucket: "ristorante-a6740.appspot.com",
          messagingSenderId: "896803417319",
          appId: "1:896803417319:web:8f68eb29a547082bf8c642",
          measurementId: "G-C1P019PEY4"
        };

// --- BOOT CHECK (temporary) ---
window.__dashboardBoot = true;
console.log("[Dashboard] Module script loaded");
// show a non-blocking, tiny banner for 2 seconds so you can confirm JS is running
(() => { 
  const b = document.createElement('div'); 
  b.id = "boot-banner"; 
  b.textContent = "Dashboard JS attivo ✔"; 
  b.style.position = "fixed"; 
  b.style.top = "8px"; 
  b.style.right = "8px"; 
  b.style.padding = "6px 10px"; 
  b.style.background = "rgba(16,185,129,0.95)"; 
  b.style.color = "#fff"; 
  b.style.font = "12px/1.2 system-ui, sans-serif"; 
  b.style.borderRadius = "8px"; 
  b.style.zIndex = "99999";
  document.addEventListener('DOMContentLoaded', () => {
    document.body.appendChild(b);
    setTimeout(() => b.remove(), 2000);
  });
})();
// --- END BOOT CHECK ---

        
        const backendUrl = 'https://upload-beckend.onrender.com';
        
        const docId = localStorage.getItem('docId');
        const restaurantId = localStorage.getItem('restaurantId');
        if (!docId) window.location.href = './login.html';

        let db;
        let menuCache = [], categoriesCache = [], allTablesData = [], historicSessionsCache = [], reservationsCache = [];
        let revenueChartInstance, ordersChartInstance, dishesPieChartInstance;
        let activeOrdersCache = new Set();
        let restaurantSettings = {};
        let settingsDebounceTimer;
        let datePicker, timePicker, timelineDatePicker;
        let selectedCategories = new Set(); // Track selected categories for pie chart
        
        // --- CORE & UTILITIES ---
        function showToast(message, type = "success") {
            const toast = document.getElementById("toast-notification");
            if (!toast) return;
            toast.textContent = message;
            toast.className = "fixed bottom-10 right-10 glass-card px-6 py-3 rounded-full shadow-lg z-50 font-semibold";
            if (type === "error") {
                toast.style.background = "rgba(var(--color-danger), 0.2)";
                toast.style.borderColor = "rgba(var(--color-danger), 0.3)";
                toast.style.color = "rgb(var(--color-danger))";
            } else if (type === "info") {
                toast.style.background = "rgba(var(--color-info), 0.2)";
                toast.style.borderColor = "rgba(var(--color-info), 0.3)";
                toast.style.color = "rgb(var(--color-info))";
            } else {
                toast.style.background = "rgba(var(--color-success), 0.2)";
                toast.style.borderColor = "rgba(var(--color-success), 0.3)";
                toast.style.color = "rgb(var(--color-success))";
            }
            toast.classList.remove('hidden');
            setTimeout(() => { toast.classList.add("hidden") }, 4000);
        }

        // Enhanced Firebase initialization with retry logic
        async function initializeFirestoreWithRetry(maxRetries = 3, delay = 1000) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    // Configure Firestore settings for better connectivity
                    db = getFirestore();
                    
                    // Test Firestore connection with a simple operation
                    await getDoc(doc(db, "ristoranti", docId));
                    console.log("Firebase Firestore connected successfully");
                    return true;
                } catch (error) {
                    console.warn(`Firebase connection attempt ${attempt} failed:`, error);
                    
                    if (attempt === maxRetries) {
                        handleFirebaseConnectionError(error);
                        return false;
                    }
                    
                    // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, attempt - 1)));
                }
            }
        }

        function handleFirebaseConnectionError(error) {
            console.error("Firebase connection failed after all retries:", error);
            
            // Show user-friendly error message
            showToast(
                "Problemi di connessione al database. Riprova tra qualche momento.", 
                "error"
            );
            
            // Implement offline mode fallback
            enableOfflineMode();
        }

        function enableOfflineMode() {
            // Add visual indicator for offline mode
            const offlineIndicator = document.createElement('div');
            offlineIndicator.id = 'offline-indicator';
            offlineIndicator.className = 'fixed top-0 left-0 right-0 bg-red-500 text-white text-center py-2 z-50';
            offlineIndicator.innerHTML = `
                <div class="flex items-center justify-center gap-2">
                    <span>⚠️</span>
                    <span>Modalità offline attiva - Alcune funzionalità potrebbero essere limitate</span>
                    <button onclick="window.location.reload()" class="ml-4 bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm">
                        Ricarica
                    </button>
                </div>
            `;
            document.body.prepend(offlineIndicator);
            
            // Disable real-time features that require Firestore
            console.log("Offline mode enabled - disabling real-time features");
            
            // Show fallback UI for main sections
            showOfflineFallbackUI();
        }

        function showOfflineFallbackUI() {
            // Update main content areas with offline messages
            const ordersActive = document.getElementById('orders-feed-active');
            const ordersCompleted = document.getElementById('orders-feed-completed');
            
            if (ordersActive) {
                ordersActive.innerHTML = `
                    <div class="glass-card p-6 text-center">
                        <p class="text-gray-600 mb-2">📡 Connessione al database non disponibile</p>
                        <p class="text-sm text-gray-500">Gli ordini in tempo reale non possono essere caricati</p>
                    </div>
                `;
            }
            
            if (ordersCompleted) {
                ordersCompleted.innerHTML = `
                    <div class="glass-card p-6 text-center">
                        <p class="text-gray-600 mb-2">📡 Dati non disponibili offline</p>
                        <p class="text-sm text-gray-500">Riprova quando la connessione sarà ripristinata</p>
                    </div>
                `;
            }
        }

        // Enhanced error handling function with better user feedback
        function handleError(error, customMessage = "Si è verificato un errore.") {
            console.error(customMessage, error);
            
            // Provide more specific error messages based on error type
            let userMessage = customMessage;
            
            if (error?.code === 'permission-denied') {
                userMessage = "Accesso negato. Verifica le tue credenziali.";
            } else if (error?.code === 'unavailable') {
                userMessage = "Servizio temporaneamente non disponibile. Riprova tra poco.";
            } else if (error?.code === 'network-request-failed') {
                userMessage = "Problema di connessione di rete. Controlla la tua connessione internet.";
            } else if (error?.message?.includes('WebChannel')) {
                userMessage = "Problema di connessione al database. Ricarica la pagina.";
            }
            
            showToast(userMessage, "error");
        }

        function setupHeader() {
            const restaurantName = localStorage.getItem('restaurantName');
            const logoUrl = localStorage.getItem('restaurantLogo');
            const headerContent = document.getElementById('header-content');
            const mobileHeaderContent = document.getElementById('mobile-header-content');

            let content = `<h1 class="text-xl font-semibold text-gray-800" style="font-family: 'Playfair Display', serif;">${restaurantName || 'Dashboard'}</h1>`;
            if (logoUrl && logoUrl !== 'null' && logoUrl !== 'undefined' && logoUrl.trim() !== '') {
                 content = `<img src="${logoUrl}" alt="Logo" class="h-10 w-10 rounded-full object-cover"><span class="ml-3 font-semibold text-lg text-gray-800" style="font-family: 'Playfair Display', serif;">${restaurantName}</span>`;
            }
            
            headerContent.innerHTML = content;
            mobileHeaderContent.textContent = restaurantName || 'Dashboard';

            document.getElementById('details-name').value = restaurantName || '';
        }

        function setupDarkMode() {
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            
            // Load dark mode preference from Firestore
            const loadDarkModePreference = async () => {
                try {
                    const settingsDoc = await getDoc(doc(db, `ristoranti/${docId}`));
                    if (settingsDoc.exists() && settingsDoc.data().darkMode !== undefined) {
                        const isDarkMode = settingsDoc.data().darkMode;
                        darkModeToggle.checked = isDarkMode;
                        applyDarkMode(isDarkMode);
                    } else {
                        // Default to system preference
                        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                        darkModeToggle.checked = prefersDark;
                        applyDarkMode(prefersDark);
                    }
                } catch (error) {
                    console.error('Error loading dark mode preference:', error);
                }
            };
            
            // Apply dark mode to the page
            const applyDarkMode = (isDark) => {
                if (isDark) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }
                
                // Update chart colors for dark mode
                updateChartColors(isDark);
            };
            
            // Save dark mode preference to Firestore
            darkModeToggle.addEventListener('change', async () => {
                const isDarkMode = darkModeToggle.checked;
                applyDarkMode(isDarkMode);
                
                try {
                    await updateDoc(doc(db, `ristoranti/${docId}`), {
                        darkMode: isDarkMode
                    });
                    showToast('Tema aggiornato!', 'success');
                } catch (error) {
                    console.error('Error saving dark mode preference:', error);
                    showToast('Errore nel salvare le preferenze del tema', 'error');
                }
            });
            
            // Update chart colors based on theme
            const updateChartColors = (isDark) => {
                const chartTextColor = isDark ? '#e5e7eb' : '#666666';
                const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
                const legendColor = isDark ? '#e5e7eb' : '#666666';
                
                // Update existing chart instances if they exist
                if (window.revenueChartInstance) {
                    window.revenueChartInstance.options.scales.x.ticks.color = chartTextColor;
                    window.revenueChartInstance.options.scales.y.ticks.color = chartTextColor;
                    window.revenueChartInstance.options.scales.x.grid.color = gridColor;
                    window.revenueChartInstance.options.scales.y.grid.color = gridColor;
                    window.revenueChartInstance.update();
                }
                
                if (window.ordersChartInstance) {
                    window.ordersChartInstance.options.scales.x.ticks.color = chartTextColor;
                    window.ordersChartInstance.options.scales.y.ticks.color = chartTextColor;
                    window.ordersChartInstance.options.scales.x.grid.color = gridColor;
                    window.ordersChartInstance.options.scales.y.grid.color = gridColor;
                    window.ordersChartInstance.update();
                }
                
                if (window.dishesPieChartInstance) {
                    window.dishesPieChartInstance.options.plugins.legend.labels.color = legendColor;
                    window.dishesPieChartInstance.update();
                }
                
                // Store current theme state
                window.currentIsDarkMode = isDark;
            };
            
            // Load preference on initialization
            loadDarkModePreference();
        }

        async function initialize() {
            try {
                // Initialize Firebase with retry logic and enhanced error handling
                const app = (typeof getApps==="function" && getApps().length ? getApp() : initializeApp(firebaseConfig))
                db = getFirestore(app);
                
                // Security: HTML escape function to prevent XSS attacks
                window.escapeHtml = function(text) {
                    if (!text) return '';
                    const map = {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#039;',
                        '/': '&#x2F;',
                        '`': '&#x60;',
                        '=': '&#x3D;'
                    };
                    return String(text).replace(/[&<>"'`=\/]/g, m => map[m]);
                }
                
                // Add enhanced connection monitoring and retry logic
                await initializeFirestoreWithRetry();

                // Setup UI components first
                setupHeader();
                setupResponsiveSidebar();
                setupReservationTabs();
                setupDarkMode();
                setupSettingsTabs();
                
                // Setup all event listeners
                setupAllEventListeners();



                listenToRestaurantSettings();
                listenToFixedTables();
                listenToMenu();
                listenToCategories();
                listenToReservations();
                listenToHistoricSessions(); // Inizia ad ascoltare le sessioni storiche fin dall'inizio
                
                // Migrate existing dishes to add order field if missing
                migrateDishOrdering();
                
                window.setAnalyticsDateFilter(0);

                // Add network status monitoring
                setupNetworkMonitoring();
                
                // Start reservation notifications monitoring
                startReservationNotifications();

            } catch (error) {
                handleError(error, "Errore di inizializzazione critico.");
            }
        }

        function startReservationNotifications() {
            if (window.reservationNotificationInterval) {
                clearInterval(window.reservationNotificationInterval);
            }
            
            window.reservationNotificationInterval = setInterval(() => {
                if (!restaurantSettings.reservationNotifications?.enabled) return;
                
                const now = new Date();
                const minutesBefore = restaurantSettings.reservationNotifications.minutesBefore || 30;
                const notificationTime = new Date(now.getTime() + minutesBefore * 60000);
                
                // Check for upcoming reservations
                reservationsCache.forEach(reservation => {
                    if (reservation.status !== 'confermata') return;
                    
                    const reservationTime = new Date(reservation.dateTime);
                    const timeDiff = reservationTime.getTime() - now.getTime();
                    const minutesUntil = Math.floor(timeDiff / 60000);
                    
                    // Check if this is approximately the right time to notify
                    if (minutesUntil > 0 && minutesUntil <= minutesBefore + 1 && minutesUntil >= minutesBefore - 1) {
                        // Check if the table is currently active
                        if (reservation.tableId) {
                            const activeTable = allTablesData.find(t => t.id === reservation.tableId && t.status === 'attivo');
                            if (activeTable) {
                                const notificationId = `reservation-${reservation.id}`;
                                
                                // Check if we already showed this notification
                                if (!window.shownNotifications) window.shownNotifications = new Set();
                                if (window.shownNotifications.has(notificationId)) return;
                                
                                window.shownNotifications.add(notificationId);
                                showReservationNotification(reservation, activeTable, minutesUntil);
                            }
                        }
                    }
                });
            }, 60000); // Check every minute
        }
        
        function showReservationNotification(reservation, activeTable, minutesUntil) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-orange-500 text-white p-4 rounded-lg shadow-lg z-50 max-w-sm';
            notification.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-bold text-sm">⚠️ Prenotazione in arrivo</h4>
                        <p class="text-xs mt-1">Tavolo <strong>${activeTable.name}</strong> è attivo ma ha una prenotazione tra ${minutesUntil} minuti</p>
                        <p class="text-xs font-semibold mt-1">${reservation.customerName} - ${new Date(reservation.dateTime).toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'})}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white/80 hover:text-white ml-2">×</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }

        function setupAllEventListeners() {
            // Setup date pickers and timeline
            setupDatePickers();
            
            // Setup navigation and view switching
            setupNavigation();
            
            // Setup analytics filters
            setupAnalyticsFilters();
            
            // Setup menu search
            setupMenuSearch();
            
            // Setup form submissions
            setupFormSubmissions();
            
            // Setup order view toggles
            setupOrderViewToggles();
        }
        
        function setupDatePickers() {
            flatpickr.localize(flatpickr.l10ns.it);
            const reservationModal = document.getElementById('reservation-modal');
            datePicker = flatpickr(reservationModal.querySelector("#reservationDate-modal"), { dateFormat: "Y-m-d", minDate: "today", onChange: () => updateTableAvailability() });
            timePicker = flatpickr(reservationModal.querySelector("#reservationTime-modal"), { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true, minuteIncrement: 15, onChange: () => updateTableAvailability() });
            
            // Add event listener for dinner duration changes
            const dinnerDurationInput = document.getElementById('dinnerDuration-modal');
            if (dinnerDurationInput) {
                dinnerDurationInput.addEventListener('input', updateTableAvailability);
            }
            
            timelineDatePicker = flatpickr("#timeline-date-picker", {
                defaultDate: "today",
                onChange: (selectedDates, dateStr) => {
                    renderReservationTimeline(selectedDates[0]);
                    updateDateFilterButtons(dateStr);
                }
            });
            
            const timelinePrevBtn = document.getElementById('timeline-prev-day');
            const timelineNextBtn = document.getElementById('timeline-next-day');
            const timelineTodayBtn = document.getElementById('timeline-today-btn');
            const timelineTomorrowBtn = document.getElementById('timeline-tomorrow-btn');
            const timelineThirdDayBtn = document.getElementById('timeline-third-day-btn');
            
            if (timelinePrevBtn) {
                timelinePrevBtn.addEventListener('click', () => { 
                    const d = timelineDatePicker.selectedDates[0] || new Date(); 
                    d.setDate(d.getDate() - 1); 
                    timelineDatePicker.setDate(d, true); 
                });
            }
            
            if (timelineNextBtn) {
                timelineNextBtn.addEventListener('click', () => { 
                    const d = timelineDatePicker.selectedDates[0] || new Date(); 
                    d.setDate(d.getDate() + 1); 
                    timelineDatePicker.setDate(d, true); 
                });
            }
            
            if (timelineTodayBtn) {
                timelineTodayBtn.addEventListener('click', () => timelineDatePicker.setDate(new Date(), true));
            }
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            if (timelineTomorrowBtn) {
                timelineTomorrowBtn.addEventListener('click', () => timelineDatePicker.setDate(tomorrow, true));
            }
            
            const thirdDay = new Date();
            thirdDay.setDate(thirdDay.getDate() + 2);
            if (timelineThirdDayBtn) {
                const dayOfWeek = thirdDay.toLocaleDateString('it-IT', { weekday: 'long' });
                const dayOfMonth = thirdDay.getDate();
                timelineThirdDayBtn.textContent = `${dayOfWeek.charAt(0).toUpperCase() + dayOfWeek.slice(1)} ${dayOfMonth}`;
                timelineThirdDayBtn.addEventListener('click', () => timelineDatePicker.setDate(thirdDay, true));
            }
            
            updateDateFilterButtons(timelineDatePicker.formatDate(new Date(), "Y-m-d"));
        }
        
        function setupNavigation() {
            document.querySelectorAll('a.nav-link[data-view]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.showView(link.getAttribute('data-view'));
                });
            });
        }
        
        function setupAnalyticsFilters() {
            const filterToday = document.getElementById('filter-today');
            const filterYesterday = document.getElementById('filter-yesterday');
            const filter7days = document.getElementById('filter-7days');
            const filter30days = document.getElementById('filter-30days');
            const filter90days = document.getElementById('filter-90days');
            
            if (filterToday) filterToday.addEventListener('click', () => window.setAnalyticsDateFilter(0));
            if (filterYesterday) filterYesterday.addEventListener('click', () => window.setAnalyticsDateFilter(1));
            if (filter7days) filter7days.addEventListener('click', () => window.setAnalyticsDateFilter(7));
            if (filter30days) filter30days.addEventListener('click', () => window.setAnalyticsDateFilter(30));
            if (filter90days) filter90days.addEventListener('click', () => window.setAnalyticsDateFilter(90));
        }
        
        function setupMenuSearch() {
            const menuSearch = document.getElementById('menu-search');
            if (menuSearch) {
                menuSearch.addEventListener('input', (e) => {
                    renderMenuList(e.target.value);
                });
            }
        }
        
        function setupFormSubmissions() {
            const addDishForm = document.getElementById('add-dish-form');
            const editDishForm = document.getElementById('edit-dish-form');
            const detailsForm = document.getElementById('details-form');
            const waiterCredentialsForm = document.getElementById('waiter-credentials-form');
            const addReservationFormModal = document.getElementById('add-reservation-form-modal');
            
            if (addDishForm) addDishForm.addEventListener('submit', window.addDish);
            if (editDishForm) editDishForm.addEventListener('submit', window.handleUpdateDish);
            if (detailsForm) detailsForm.addEventListener('submit', window.handleDetailsUpdate);
            if (waiterCredentialsForm) waiterCredentialsForm.addEventListener('submit', window.handleWaiterCredentialsUpdate);
            if (addReservationFormModal) addReservationFormModal.addEventListener('submit', window.handleReservationFormSubmit);
        }
        
        function setupOrderViewToggles() {
            const viewByTables = document.getElementById('view-by-tables');
            const viewByDishes = document.getElementById('view-by-dishes');
            
            if (viewByTables) {
                viewByTables.addEventListener('click', () => {
                    currentOrderView = 'tables';
                    document.getElementById('view-by-tables').classList.add('active');
                    document.getElementById('view-by-dishes').classList.remove('active');
                    renderOrderFeeds(allTablesData);
                });
            }
            
            if (viewByDishes) {
                viewByDishes.addEventListener('click', () => {
                    currentOrderView = 'dishes';
                    document.getElementById('view-by-dishes').classList.add('active');
                    document.getElementById('view-by-tables').classList.remove('active');
                    renderOrderFeeds(allTablesData);
                });
            }
        }
        
        function setupNetworkMonitoring() {
            function updateNetworkStatus() {
                const offlineIndicator = document.getElementById('offline-indicator');
                
                if (!navigator.onLine) {
                    if (!offlineIndicator) {
                        enableOfflineMode();
                    }
                } else {
                    if (offlineIndicator) {
                        offlineIndicator.remove();
                        showToast("Connessione ripristinata", "info");
                        
                        // Retry Firebase connections if they failed
                        retryFailedConnections();
                    }
                }
            }
            
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
            
            // Initial status check
            updateNetworkStatus();
        }

        function retryFailedConnections() {
            console.log("Retrying failed Firebase connections...");
            
            // Retry Firebase initialization
            initializeFirestoreWithRetry().then(success => {
                if (success) {
                    // Restart listeners that may have failed
                    if (window.reservationsUnsubscribe) {
                        window.reservationsUnsubscribe();
                        listenToReservations();
                    }
                    if (window.tablesUnsubscribe) {
                        window.tablesUnsubscribe();
                        listenToFixedTables();
                    }
                    if (window.settingsUnsubscribe) {
                        window.settingsUnsubscribe();
                        listenToRestaurantSettings();
                    }
                }
            });
        }

        function setupResponsiveSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const mobileMenuButton = document.getElementById('mobile-menu-button');

            if (!sidebar || !overlay || !mobileMenuButton) {
                console.warn('Sidebar elements not found');
                return;
            }

            const toggleSidebar = () => {
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            };

            mobileMenuButton.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                toggleSidebar();
            });
            
            overlay.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                toggleSidebar();
            });

            document.querySelectorAll('#sidebar .nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    if (window.innerWidth < 768 && !overlay.classList.contains('hidden')) {
                        toggleSidebar();
                    }
                });
            });
        }

        window.showView = (viewId) => {
            console.log('showView called with:', viewId);
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            const targetSection = document.getElementById(viewId);
            if (targetSection) {
                targetSection.classList.add('active');
            } else {
                console.warn('View section not found:', viewId);
            }

            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const targetNavLink = document.querySelector(`.nav-link[data-view="${viewId}"]`);
            if (targetNavLink) {
                targetNavLink.classList.add('active');
            }

            if (viewId === 'analitiche') {
                applyCustomDateFilter(); // Applica il filtro quando si mostra la vista analitiche
            }
            if (viewId === 'prenotazioni') {
                const tableSelect = document.getElementById('reservationTable-modal');
                if (tableSelect) {
                    populateTableSelect(tableSelect);
                }
            }
        };

        window.logout = () => {
            localStorage.clear();
            window.location.href = './login.html';
        };


        function listenToReservations() {
            const q = query(collection(db, `ristoranti/${docId}/prenotazioni`), orderBy("dateTime", "desc"));
            
            const unsubscribe = onSnapshot(q, (snapshot) => {
                reservationsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderReservations();
                renderReservationTimeline(timelineDatePicker.selectedDates[0] || new Date());
                updateTableAvailability();
            }, (err) => {
                console.error("Error in reservations listener:", err);
                handleError(err, "Errore nel caricamento delle prenotazioni.");
                
                // Retry after delay
                setTimeout(() => {
                    console.log("Retrying reservations listener...");
                    listenToReservations();
                }, 5000);
            });
            
            // Store unsubscribe function for cleanup
            window.reservationsUnsubscribe = unsubscribe;
        }

        let currentReservationView = 'future';

        function setupSettingsTabs() {
            const tabs = document.querySelectorAll('.settings-tab');
            const panels = document.querySelectorAll('.settings-panel');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and panels
                    tabs.forEach(t => {
                        t.classList.remove('active', 'text-[var(--gold-accent)]', 'border-[var(--gold-accent)]');
                        t.classList.add('text-gray-500');
                    });
                    panels.forEach(p => p.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding panel
                    tab.classList.add('active', 'text-[var(--gold-accent)]', 'border-[var(--gold-accent)]');
                    tab.classList.remove('text-gray-500');
                    
                    const targetPanel = document.getElementById(tab.dataset.tab + '-panel');
                    if (targetPanel) {
                        targetPanel.classList.add('active');
                    }
                });
            });
        }

        function setupReservationTabs() {
            const tabFuture = document.getElementById('tab-future');
            const tabPast = document.getElementById('tab-past');

            if(tabFuture && tabPast) {
                tabFuture.addEventListener('click', () => {
                    currentReservationView = 'future';
                    tabFuture.classList.add('active');
                    tabPast.classList.remove('active');
                    renderReservations();
                });

                tabPast.addEventListener('click', () => {
                    currentReservationView = 'past';
                    tabPast.classList.add('active');
                    tabFuture.classList.remove('active');
                    renderReservations();
                });
            }
        }
        
        function renderReservations() {
            const container = document.getElementById('reservations-list-container');
            if(!container) return;
            container.innerHTML = '';
            const now = new Date();

            const reservationsToRender = reservationsCache.filter(res => {
                const resDate = res.dateTime.toDate();
                const isPast = resDate < now || res.status === 'completata' || res.status === 'annullata';
                return currentReservationView === 'future' ? !isPast : isPast;
            });

            if (reservationsToRender.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-4">Nessuna prenotazione da mostrare.</p>`;
                return;
            }

            reservationsToRender.forEach(res => {
                const resDate = res.dateTime.toDate();
                const resTime = resDate.toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit'});
                const resDay = resDate.toLocaleDateString('it-IT', {weekday: 'long', day: '2-digit', month: 'long'});
                
                // Calculate end time using dinnerDuration
                const dinnerDuration = res.dinnerDuration || restaurantSettings.dinnerDuration || 90;
                const endDate = new Date(resDate.getTime() + dinnerDuration * 60 * 1000);
                const endTime = endDate.toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit'});

                let actionButtons = '';
                if (currentReservationView === 'future') {
                     actionButtons = `
                        <button onclick="window.handleCheckIn('${res.id}')" class="text-xs btn-success font-semibold py-1 px-3 rounded-md hover:opacity-90 disabled:bg-gray-400 disabled:cursor-not-allowed" ${!res.tableId ? 'disabled' : ''} title="${!res.tableId ? 'Assegna un tavolo per il check-in' : 'Fai accomodare i clienti'}">Check-in</button>
                        <button onclick="window.openEditReservationModal('${res.id}')" class="text-xs bg-gray-500 text-white font-semibold py-1 px-2 rounded-md hover:bg-gray-600">Modifica</button>
                        <button onclick="window.updateReservationStatus('${res.id}', 'annullata')" class="text-xs btn-danger font-semibold py-1 px-2 rounded-md hover:opacity-90">Annulla</button>
                    `;
                }

                const cardHtml = `
                <div class="glass-card p-4 rounded-lg border-l-4 ${res.status === 'annullata' ? 'border-red-500' : 'border-gold-accent'}">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-lg text-gray-800">${res.customerName}</p>
                            <p class="text-sm text-gray-600">${res.tableName || 'Nessun tavolo'}</p>
                        </div>
                        <div class="text-right flex-shrink-0 ml-4">
                            <p class="text-2xl font-bold text-gold-accent">${resTime} - ${endTime}</p>
                            <p class="text-sm font-medium text-gray-600">${resDay}</p>
                            <p class="text-xs text-gray-500">${dinnerDuration} min</p>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200 flex justify-between items-center">
                        <div class="text-sm text-gray-600 font-medium">
                            👤 ${res.partySize} Persone
                        </div>
                        <div class="flex gap-2">
                            ${actionButtons}
                        </div>
                    </div>
                </div>`;
                container.innerHTML += cardHtml;
            });
        }

        function updateDateFilterButtons(selectedDateStr) {
            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);
            const thirdDay = new Date();
            thirdDay.setDate(today.getDate() + 2);

            const formatDate = (date) => date.toISOString().split('T')[0];
            const todayStr = formatDate(today);
            const tomorrowStr = formatDate(tomorrow);
            const thirdDayStr = formatDate(thirdDay);
            
            document.getElementById('timeline-today-btn').classList.toggle('active', selectedDateStr === todayStr);
            document.getElementById('timeline-tomorrow-btn').classList.toggle('active', selectedDateStr === tomorrowStr);
            document.getElementById('timeline-third-day-btn').classList.toggle('active', selectedDateStr === thirdDayStr);
        }

        function renderReservationTimeline(date) {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '';
            container.className = 'timeline-grid min-w-[1200px] relative'; 

            // Get time range from settings or use defaults
            const startHour = restaurantSettings.timeRange?.startHour || 11;
            const endHour = restaurantSettings.timeRange?.endHour || 25;
            const totalHours = endHour - startHour;

            // Set CSS custom properties for dynamic grid
            document.documentElement.style.setProperty('--total-hours', totalHours);
            document.documentElement.style.setProperty('--total-hours-double', totalHours * 2);

            const headerRow = document.createElement('div');
            headerRow.className = 'contents';

            const tavoloHeader = document.createElement('div');
            tavoloHeader.className = 'timeline-header sticky left-0 z-10 bg-white';
            tavoloHeader.textContent = 'Tavolo';
            headerRow.appendChild(tavoloHeader);

            const timeHeaderGrid = document.createElement('div');
            timeHeaderGrid.className = 'timeline-hours-grid';
            timeHeaderGrid.style.gridTemplateColumns = `repeat(${totalHours}, 1fr)`;

            for(let i = startHour; i < endHour; i++) {
                const hourDiv = document.createElement('div');
                hourDiv.className = 'timeline-header text-left pl-0';
                hourDiv.textContent = `${i}:00`;
                timeHeaderGrid.appendChild(hourDiv);
            }
            headerRow.appendChild(timeHeaderGrid);
            container.appendChild(headerRow);
            
            // Add current time indicator if viewing today
            const today = new Date();
            const isToday = date.toDateString() === today.toDateString();
            if (isToday) {
                const currentHour = today.getHours();
                const currentMinutes = today.getMinutes();
                if (currentHour >= startHour && currentHour < endHour) {
                    const totalMinutes = (currentHour - startHour) * 60 + currentMinutes;
                    const percentage = (totalMinutes / (totalHours * 60)) * 100;
                    
                    const currentTimeLine = document.createElement('div');
                    currentTimeLine.className = 'absolute top-0 bottom-0 w-px bg-red-400/60 z-20 pointer-events-none';
                    currentTimeLine.style.left = `calc(120px + ${percentage}% - 0.5px)`;
                    const currentTimeText = String(currentHour).padStart(2, '0') + ':' + String(currentMinutes).padStart(2, '0');
                    currentTimeLine.innerHTML = `<div class="absolute -top-6 -left-6 bg-red-400/80 text-white text-xs px-1.5 py-0.5 rounded text-center whitespace-nowrap">${currentTimeText}</div>`;
                    container.appendChild(currentTimeLine);
                }
            }
            const tables = allTablesData.sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric: true}));

            tables.forEach(table => {
                const tableRow = document.createElement('div');
                tableRow.className = 'contents';

                const nameCell = document.createElement('div');
                nameCell.className = 'timeline-table-name sticky left-0 z-10 bg-white';
                nameCell.textContent = table.name;
                tableRow.appendChild(nameCell);

                const rowBackground = document.createElement('div');
                rowBackground.className = 'relative timeline-row-bg';
                rowBackground.onclick = (e) => {
                    const rect = e.currentTarget.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const percentage = clickX / rect.width;
                    const totalMinutes = totalHours * 60; 
                    const clickedMinute = totalMinutes * percentage;

                    const timeSlot = new Date(date);
                    timeSlot.setHours(startHour, 0, 0, 0);
                    timeSlot.setMinutes(timeSlot.getMinutes() + clickedMinute);

                    const minutes = timeSlot.getMinutes();
                    const roundedMinutes = Math.round(minutes / 15) * 15;
                    timeSlot.setMinutes(roundedMinutes);

                    openReservationFormFromTimeline(table.id, timeSlot);
                };

                const dayStart = new Date(date); dayStart.setHours(startHour, 0, 0, 0);
                const dayEnd = new Date(date); dayEnd.setHours(endHour - 1, 59, 59, 999);
                reservationsCache.filter(r => r.tableId === table.id && r.dateTime.toDate() >= dayStart && r.dateTime.toDate() <= dayEnd && r.status === 'confermata')
                    .forEach(res => {
                        const block = document.createElement('div');
                        const resDate = res.dateTime.toDate();
                        const startMinutes = (resDate.getHours() - startHour) * 60 + resDate.getMinutes();
                        const left = (startMinutes / (totalHours * 60)) * 100;
                        // Usa la durata specifica della prenotazione o il default
                        const reservationDuration = res.dinnerDuration || restaurantSettings.dinnerDuration || 90; // Default 90 minuti
                        console.log('Prenotazione:', res.customerName, 'Durata:', reservationDuration, 'minuti');
                        const width = (reservationDuration / (totalHours * 60)) * 100;

                        block.className = 'reservation-block';
                        block.style.left = `${left}%`;
                        block.style.width = `${width}%`;
                        block.textContent = res.customerName;
                        block.title = `${res.customerName} - ${res.partySize}pax\nOre: ${resDate.toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit'})}`;
                        block.onclick = (e) => {
                            e.stopPropagation();
                            window.openEditReservationModal(res.id);
                        };
                        rowBackground.appendChild(block);
                    });

                tableRow.appendChild(rowBackground);
                container.appendChild(tableRow);
            });
        }

        function openReservationFormFromTimeline(tableId, date) {
            const modal = document.getElementById('reservation-modal');
            const form = document.getElementById('add-reservation-form-modal');
            const modalTitle = document.getElementById('reservation-modal-title');
            form.reset();
            form.querySelector('#reservation-form-id').value = '';
            
            const table = allTablesData.find(t => t.id === tableId);
            const timeStr = date.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'});
            modalTitle.textContent = `Prenota ${table.name} alle ${timeStr}`;

            datePicker.setDate(date, true);
            timePicker.setDate(date, true);
            
            // Set default dinner duration
            document.getElementById('dinnerDuration-modal').value = restaurantSettings.dinnerDuration || 90;

            populateTableSelect(form.querySelector('#reservationTable-modal'));
            form.querySelector('#reservationTable-modal').value = tableId;
            updateTableAvailability();
            modal.classList.remove('hidden');
        }

        window.openEditReservationModal = (reservationId) => {
            const reservation = reservationId ? reservationsCache.find(r => r.id === reservationId) : null;
            
            const modal = document.getElementById('reservation-modal');
            const form = document.getElementById('add-reservation-form-modal');
            const modalTitle = document.getElementById('reservation-modal-title');
            const submitBtn = document.getElementById('reservation-form-submit-btn');
            
            form.reset();
            
            // Set default dinner duration
            document.getElementById('dinnerDuration-modal').value = restaurantSettings.dinnerDuration || 90;
            
            if (reservation) {
                modalTitle.textContent = 'Modifica Prenotazione';
                submitBtn.textContent = 'Salva Modifiche';
                form.querySelector('#reservation-form-id').value = reservation.id;
                form.querySelector('#customerName-modal').value = reservation.customerName;
                form.querySelector('#partySize-modal').value = reservation.partySize;
                form.querySelector('#customerPhone-modal').value = reservation.customerPhone || '';
                const resDate = reservation.dateTime.toDate();
                datePicker.setDate(resDate, true);
                timePicker.setDate(resDate, true);
                form.querySelector('#reservationTable-modal').value = reservation.tableId || '';
                document.getElementById('dinnerDuration-modal').value = reservation.dinnerDuration || restaurantSettings.dinnerDuration || 90;
            } else {
                modalTitle.textContent = 'Crea Nuova Prenotazione';
                submitBtn.textContent = 'Salva Prenotazione';
                form.querySelector('#reservation-form-id').value = '';
            }

            populateTableSelect(form.querySelector('#reservationTable-modal'));
            updateTableAvailability();
            modal.classList.remove('hidden');
        };

        function updateTableAvailability() {
            const form = document.getElementById('add-reservation-form-modal');
            const dateStr = form.querySelector('#reservationDate-modal').value;
            const timeStr = form.querySelector('#reservationTime-modal').value;
            const selectElement = form.querySelector('#reservationTable-modal');
            const currentReservationId = form.querySelector('#reservation-form-id').value;

            Array.from(selectElement.options).forEach(option => {
                if (option.value) {
                     const table = allTablesData.find(t => t.id === option.value);
                     if(table) option.textContent = table.name;
                     option.disabled = false;
                }
            });

            if(!dateStr || !timeStr) return;

            const selectedDateTime = new Date(`${dateStr}T${timeStr}`);
            const dinnerDurationMinutes = parseInt(form.querySelector('#dinnerDuration-modal').value) || restaurantSettings.dinnerDuration || 90;
            const reservationEndTime = new Date(selectedDateTime.getTime() + dinnerDurationMinutes * 60 * 1000);

            const occupiedTableIds = new Set();
            reservationsCache.forEach(res => {
                if (res.id === currentReservationId) return;
                if (res.status !== 'confermata' || !res.tableId) return;
                const resDate = res.dateTime.toDate();
                const resDuration = res.dinnerDuration || restaurantSettings.dinnerDuration || 90;
                const resEndDate = new Date(resDate.getTime() + resDuration * 60 * 1000);
                if(selectedDateTime < resEndDate && reservationEndTime > resDate) {
                    occupiedTableIds.add(res.tableId);
                }
            });

            Array.from(selectElement.options).forEach(option => {
                if (option.value) {
                    const table = allTablesData.find(t => t.id === option.value);
                    if(table && occupiedTableIds.has(option.value)) {
                        option.textContent = `${table.name} (Occupato)`;
                        option.disabled = true;
                    }
                }
            });
        }

        window.handleReservationFormSubmit = (e) => {
            e.preventDefault();
            const form = e.target;
            const reservationId = form.querySelector('#reservation-form-id').value;

            if (reservationId) {
                window.handleUpdateReservation(reservationId, form);
            } else {
                window.handleCreateReservation(form);
            }
        };

        window.handleCreateReservation = async (form) => {
            const tableSelect = form.querySelector('#reservationTable-modal');
            const selectedOption = tableSelect.options[tableSelect.selectedIndex];
            const date = form.querySelector('#reservationDate-modal').value;
            const time = form.querySelector('#reservationTime-modal').value;
            if (!date || !time) return showToast("Data e ora sono obbligatorie", "error");

            const reservationData = {
                customerName: form.querySelector('#customerName-modal').value,
                customerPhone: form.querySelector('#customerPhone-modal').value,
                partySize: parseInt(form.querySelector('#partySize-modal').value),
                tableId: tableSelect.value || '',
                tableName: selectedOption && selectedOption.value ? selectedOption.textContent.replace(' (Occupato)', '') : 'Non assegnato',
                dateTime: new Date(`${date}T${time}`).toISOString(),
                dinnerDuration: parseInt(form.querySelector('#dinnerDuration-modal').value) || restaurantSettings.dinnerDuration || 90
            };

            try {
                showToast('Creazione prenotazione...', 'info');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
                
                const response = await fetch(`${backendUrl}/restaurants/${docId}/reservations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reservationData),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                
                showToast('Prenotazione creata!', 'success');
                document.getElementById('reservation-modal').classList.add('hidden');
            } catch(error) {
                console.error("Errore creazione prenotazione:", error);
                
                let errorMessage = "Errore durante la creazione della prenotazione.";
                if (error.name === 'AbortError') {
                    errorMessage = "Timeout della richiesta. Riprova.";
                } else if (error.message.includes('fetch')) {
                    errorMessage = "Errore di connessione. Verifica la tua connessione internet.";
                }
                
                handleError(error, errorMessage);
            }
        };

        window.handleUpdateReservation = async (reservationId, form) => {
             const tableSelect = form.querySelector('#reservationTable-modal');
             const selectedOption = tableSelect.options[tableSelect.selectedIndex];
             const date = form.querySelector('#reservationDate-modal').value;
             const time = form.querySelector('#reservationTime-modal').value;
             if (!date || !time) return showToast("Data e ora sono obbligatorie", "error");

             const updatedData = {
                customerName: form.querySelector('#customerName-modal').value,
                customerPhone: form.querySelector('#customerPhone-modal').value,
                partySize: parseInt(form.querySelector('#partySize-modal').value),
                tableId: tableSelect.value || '',
                tableName: selectedOption && selectedOption.value ? selectedOption.textContent.replace(' (Occupato)', '') : 'Non assegnato',
                dateTime: new Date(`${date}T${time}`).toISOString(),
                dinnerDuration: parseInt(form.querySelector('#dinnerDuration-modal').value) || restaurantSettings.dinnerDuration || 90
             };

             try {
                const response = await fetch(`${backendUrl}/restaurants/${docId}/reservations/${reservationId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                showToast('Prenotazione aggiornata!', 'success');
                document.getElementById('reservation-modal').classList.add('hidden');
             } catch(error) {
                handleError(error, "Errore aggiornamento prenotazione.");
             }
        };

        window.updateReservationStatus = async (reservationId, newStatus) => {
            const message = `Segnare questa prenotazione come "${newStatus}"?`;
            if (!confirm(message)) return;

            try {
                 const response = await fetch(`${backendUrl}/restaurants/${docId}/reservations/${reservationId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                showToast('Stato prenotazione aggiornato.', 'info');
            } catch (error) {
                 handleError(error);
            }
        };

        window.handleCheckIn = async (reservationId) => {
            showToast('Check-in in corso...', 'info');
            
            // First check if the table is currently active
            const reservation = reservationsCache.find(r => r.id === reservationId);
            if (reservation && reservation.tableId) {
                const activeTable = allTablesData.find(t => t.id === reservation.tableId && t.status === 'attivo');
                if (activeTable) {
                    const proceed = confirm(`Il tavolo ${activeTable.name} è attualmente attivo. Procedere con il check-in chiuderà la sessione corrente. Vuoi continuare?`);
                    if (!proceed) {
                        showToast('Check-in annullato.', 'info');
                        return;
                    }
                }
            }
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                const response = await fetch(`${backendUrl}/restaurants/${docId}/check-in/${reservationId}`, { 
                    method: 'POST',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);

                document.getElementById('check-in-customer-name').textContent = `Cliente: ${result.customerName}`;
                document.getElementById('check-in-table-name').textContent = result.tableName;
                document.getElementById('check-in-pin').textContent = result.pin;
                document.getElementById('check-in-modal').classList.remove('hidden');

            } catch (error) {
                console.error("Errore check-in:", error);
                
                let errorMessage = "Errore durante il check-in.";
                if (error.name === 'AbortError') {
                    errorMessage = "Timeout della richiesta di check-in. Riprova.";
                } else if (error.message.includes('fetch')) {
                    errorMessage = "Errore di connessione durante il check-in.";
                }
                
                handleError(error, errorMessage);
            }
        };

        function populateTableSelect(selectElement) {
            const currentValue = selectElement.value;
            selectElement.innerHTML = '<option value="">Non specificato</option>';
            allTablesData.sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric: true})).forEach(table => {
                const option = document.createElement('option');
                option.value = table.id;
                option.textContent = table.name;
                selectElement.appendChild(option);
            });
            selectElement.value = currentValue;
        }
        function listenToRestaurantSettings() {
            const unsubscribe = onSnapshot(doc(db, "ristoranti", docId), (docSnap) => {
                if (docSnap.exists()) {
                    const defaults = { 
                        ayce: { enabled: false, price: 0, limitOrders: false, maxOrders: 1 }, 
                        coperto: { enabled: false, price: 0 }, 
                        waiterMode: { enabled: false, username: 'cameriere' },
                        timeRange: { startHour: 11, endHour: 25 },
                        dinnerDuration: 90,
                        reservationNotifications: { enabled: false, minutesBefore: 30 }
                    };
                    const remoteSettings = docSnap.data().settings || {};
                    restaurantSettings = {
                        ayce: { ...defaults.ayce, ...(remoteSettings.ayce || {}) },
                        coperto: { ...defaults.coperto, ...(remoteSettings.coperto || {}) },
                        waiterMode: { ...defaults.waiterMode, ...(remoteSettings.waiterMode || {}) },
                        timeRange: { ...defaults.timeRange, ...(remoteSettings.timeRange || {}) },
                        dinnerDuration: remoteSettings.dinnerDuration || defaults.dinnerDuration,
                        reservationNotifications: { ...defaults.reservationNotifications, ...(remoteSettings.reservationNotifications || {}) },
                    };
                    updateSettingsUI();
                    updateAyceDependantUI();
                    if (allTablesData.length > 0) renderTablesGrid(allTablesData);
                    // Re-render timeline with new settings
                    renderReservationTimeline(timelineDatePicker.selectedDates[0] || new Date());
                }
            }, (err) => {
                console.error("Error in restaurant settings listener:", err);
                handleError(err, "Errore nel caricamento delle impostazioni.");
                
                // Retry after delay
                setTimeout(() => {
                    console.log("Retrying restaurant settings listener...");
                    listenToRestaurantSettings();
                }, 5000);
            });
            
            window.settingsUnsubscribe = unsubscribe;
        }
        function updateAyceDependantUI() {
            const isAyceEnabled = restaurantSettings.ayce?.enabled || false;
            document.getElementById('add-extra-charge-container').style.display = isAyceEnabled ? 'flex' : 'none';
            document.getElementById('edit-extra-charge-container').style.display = isAyceEnabled ? 'flex' : 'none';
        }
        function updateSettingsUI() {
            const { waiterMode, ayce, coperto, timeRange, dinnerDuration, reservationNotifications } = restaurantSettings;
            const waiterToggle = document.getElementById('waiter-mode-toggle');
            waiterToggle.checked = waiterMode.enabled;
            document.getElementById('waiter-mode-options').classList.toggle('hidden', !waiterMode.enabled);
            document.getElementById('waiter-username').value = waiterMode.username;
            waiterToggle.onchange = (e) => {
                document.getElementById('waiter-mode-options').classList.toggle('hidden', !e.target.checked);
                saveSettingsWithDebounce();
            };
            const ayceToggle = document.getElementById('ayce-toggle');
            ayceToggle.checked = ayce.enabled;
            document.getElementById('ayce-options-container').classList.toggle('hidden', !ayce.enabled);
            document.getElementById('ayce-price').value = ayce.price;
            ayceToggle.onchange = (e) => {
                document.getElementById('ayce-options-container').classList.toggle('hidden', !e.target.checked);
                saveSettingsWithDebounce();
            };
            const ayceLimitToggle = document.getElementById('ayce-limit-orders-toggle');
            ayceLimitToggle.checked = ayce.limitOrders;
            document.getElementById('ayce-max-orders-container').classList.toggle('hidden', !ayce.limitOrders);
            document.getElementById('ayce-max-orders').value = ayce.maxOrders;
            ayceLimitToggle.onchange = (e) => {
                document.getElementById('ayce-max-orders-container').classList.toggle('hidden', !e.target.checked);
                saveSettingsWithDebounce();
            };
            const copertoToggle = document.getElementById('coperto-toggle');
            copertoToggle.checked = coperto.enabled;
            document.getElementById('coperto-price-container').classList.toggle('hidden', !coperto.enabled);
            document.getElementById('coperto-price').value = coperto.price;
            copertoToggle.onchange = (e) => {
                document.getElementById('coperto-price-container').classList.toggle('hidden', !e.target.checked);
                saveSettingsWithDebounce();
            };
            
            // Reservation settings
            document.getElementById('timeline-start-hour').value = timeRange.startHour;
            document.getElementById('timeline-end-hour').value = timeRange.endHour;
            document.getElementById('dinner-duration').value = dinnerDuration;
            
            // Reservation notifications
            const notificationsToggle = document.getElementById('reservation-notifications-toggle');
            notificationsToggle.checked = reservationNotifications.enabled;
            document.getElementById('reservation-notifications-options').classList.toggle('hidden', !reservationNotifications.enabled);
            document.getElementById('notification-minutes').value = reservationNotifications.minutesBefore;
            notificationsToggle.onchange = (e) => {
                document.getElementById('reservation-notifications-options').classList.toggle('hidden', !e.target.checked);
                saveSettingsWithDebounce();
            };
            
            ['ayce-price', 'ayce-max-orders', 'coperto-price', 'timeline-start-hour', 'timeline-end-hour', 'dinner-duration', 'notification-minutes'].forEach(id => {
                document.getElementById(id).oninput = saveSettingsWithDebounce;
            });
        }
        function saveSettingsWithDebounce() {
            clearTimeout(settingsDebounceTimer);
            settingsDebounceTimer = setTimeout(async () => {
                try {
                    const newSettings = {
                        ...restaurantSettings,
                        waiterMode: { ...restaurantSettings.waiterMode, enabled: document.getElementById('waiter-mode-toggle').checked },
                        ayce: { ...restaurantSettings.ayce, enabled: document.getElementById('ayce-toggle').checked, price: parseFloat(document.getElementById('ayce-price').value) || 0, limitOrders: document.getElementById('ayce-limit-orders-toggle').checked, maxOrders: parseInt(document.getElementById('ayce-max-orders').value) || 1 },
                        coperto: { ...restaurantSettings.coperto, enabled: document.getElementById('coperto-toggle').checked, price: parseFloat(document.getElementById('coperto-price').value) || 0 },
                        timeRange: { 
                            startHour: parseInt(document.getElementById('timeline-start-hour').value) || 11, 
                            endHour: parseInt(document.getElementById('timeline-end-hour').value) || 25 
                        },
                        dinnerDuration: parseInt(document.getElementById('dinner-duration').value) || 90,
                        reservationNotifications: {
                            enabled: document.getElementById('reservation-notifications-toggle').checked,
                            minutesBefore: parseInt(document.getElementById('notification-minutes').value) || 30
                        }
                    };
                    await updateDoc(doc(db, "ristoranti", docId), { settings: newSettings });
                    
                    // Update the timeline if dinner duration changed
                    if (newSettings.dinnerDuration !== restaurantSettings.dinnerDuration) {
                        renderReservationTimeline(timelineDatePicker.selectedDates[0] || new Date());
                    }
                    
                    showToast("Impostazioni salvate!", "info");
                } catch (error) {
                    handleError(error, "Errore nel salvataggio delle impostazioni.");
                }
            }, 800);
        }
        window.handleWaiterCredentialsUpdate = async (e) => {
            e.preventDefault();
            const form = e.target;
            const username = form.querySelector('#waiter-username').value.trim();
            const password = form.querySelector('#waiter-password').value;
            if (!username) return showToast('L\'username non può essere vuoto.', 'error');
            
            // Check for duplicate usernames
            if (username !== restaurantSettings.waiterMode.username) {
                showToast('Controllo disponibilità username...', 'info');
                try {
                    const checkResponse = await fetch(`${backendUrl}/check-username-availability`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, type: 'waiter' })
                    });
                    const checkResult = await checkResponse.json();
                    if (!checkResult.available) {
                        return showToast('Username già in uso da un altro ristorante o cameriere.', 'error');
                    }
                } catch (error) {
                    console.error('Username check error:', error);
                    return showToast('Errore nel controllo username.', 'error');
                }
            }
            
            showToast('Salvataggio...', 'info');
            try {
                const response = await fetch(`${backendUrl}/update-waiter-credentials/${docId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                showToast(result.message, 'success');
                form.querySelector('#waiter-password').value = '';
            } catch(error) {
                handleError(error, "Impossibile salvare le credenziali.");
            }
        };
        window.handleDetailsUpdate = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            showToast('Salvataggio dati...', 'info');
            try {
                const response = await fetch(`${backendUrl}/update-restaurant-details/${docId}`, { method: 'POST', body: formData });
                if (!response.ok) throw new Error((await response.json()).error);
                const result = await response.json();
                localStorage.setItem('restaurantName', result.nomeRistorante);
                localStorage.setItem('restaurantLogo', result.logoUrl);
                setupHeader();
                showToast(result.message, 'success');
            } catch(error) {
                handleError(error, "Errore aggiornamento dati.");
            }
        };
        
        function calculateBill(table, settings) {
            let total = 0;
            const guests = table.guests || 0;
            const allItems = [...Object.values(table.orders || {}).flat(), ...(table.orderHistory || [])];
            if (settings.ayce?.enabled && guests > 0) {
                total += (settings.ayce.price || 0) * guests;
                allItems.forEach(item => {
                    if (item.isExtraCharge) total += (item.price || 0) * (item.quantity || 1);
                });
            } else {
                total = allItems.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);
            }
            if (settings.coperto?.enabled && guests > 0) {
                total += (settings.coperto.price || 0) * guests;
            }
            return total;
        }

        let renderDebounceTimer = null;
        
        function listenToFixedTables() {
            const unsubscribe = onSnapshot(query(collection(db, `ristoranti/${docId}/fixedTables`)), (snapshot) => {
                allTablesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Debounce render to avoid conflicts with local updates
                if (renderDebounceTimer) clearTimeout(renderDebounceTimer);
                renderDebounceTimer = setTimeout(() => {
                    renderOrderFeeds(allTablesData);
                    renderTablesGrid(allTablesData);
                    populateTableSelect(document.getElementById('reservationTable-modal'));
                }, 100);
            }, (err) => {
                console.error("Error in fixed tables listener:", err);
                handleError(err, "Errore nel caricamento dei tavoli.");
                
                // Retry after delay
                setTimeout(() => {
                    console.log("Retrying fixed tables listener...");
                    listenToFixedTables();
                }, 5000);
            });
            
            window.tablesUnsubscribe = unsubscribe;
        }
        
        function listenToHistoricSessions() {
            onSnapshot(query(collection(db, `ristoranti/${docId}/historicSessions`), orderBy("paidAt", "desc")), (snapshot) => {
                historicSessionsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (document.getElementById('analitiche').classList.contains('active')) {
                    applyCustomDateFilter();
                }
            });
        }

        let currentOrderView = 'tables'; // 'tables' o 'dishes'
        
        function renderOrderFeeds(tables) {
            const activeFeed = document.getElementById('orders-feed-active');
            const completedFeed = document.getElementById('orders-feed-completed');
            const loadingActive = document.getElementById('loading-state-active');
            const loadingCompleted = document.getElementById('loading-state-completed');
            activeFeed.innerHTML = '';
            completedFeed.innerHTML = '';
            let allActiveOrders = [];
            let completedOrders = [];
            const newActiveOrders = new Set();

            tables.forEach(table => {
                if (table.status !== 'attivo') return;
                
                // Ordini attivi
                Object.values(table.orders || {}).flat().forEach(item => {
                    allActiveOrders.push({ ...item, tableId: table.id, tableName: table.name });
                    newActiveOrders.add(item.cartItemId);
                });
                
                // Ordini completati (tutti gli elementi in orderHistory sono completati)
                (table.orderHistory || []).forEach(item => {
                    completedOrders.push({ ...item, tableId: table.id, tableName: table.name });
                });
            });
            
            if (newActiveOrders.size > activeOrdersCache.size) {
                document.getElementById('notification-sound').play().catch(e => {});
            }
            activeOrdersCache = newActiveOrders;
            loadingActive.style.display = allActiveOrders.length > 0 ? 'none' : 'block';
            
            if (currentOrderView === 'dishes') {
                // Raggruppa per piatto
                const ordersByDish = {};
                allActiveOrders.forEach(item => {
                    const key = item.name;
                    if (!ordersByDish[key]) {
                        ordersByDish[key] = [];
                    }
                    ordersByDish[key].push(item);
                });
                
                Object.entries(ordersByDish).forEach(([dishName, items]) => {
                    activeFeed.innerHTML += createDishGroupCard(dishName, items);
                });
            } else {
                // Vista per tavoli (default)
                allActiveOrders.forEach(item => activeFeed.innerHTML += createActiveOrderCard(item));
            }
            
            loadingCompleted.style.display = completedOrders.length > 0 ? 'none' : 'block';
            
            // Ordina gli ordini completati per data di completamento (più recenti prima)
            completedOrders.sort((a, b) => {
                const aTime = a.completedAt?.toMillis ? a.completedAt.toMillis() : new Date(a.completedAt).getTime();
                const bTime = b.completedAt?.toMillis ? b.completedAt.toMillis() : new Date(b.completedAt).getTime();
                return bTime - aTime;
            });
            
            completedOrders.forEach(item => completedFeed.innerHTML += createCompletedOrderCard(item));
        }
        
        function createDishGroupCard(dishName, items) {
            const totalQuantity = items.reduce((sum, item) => sum + item.quantity, 0);
            const tables = items.map(item => `${item.tableName} (x${item.quantity})`).join(', ');
            const itemsHtml = items.map(item => {
                const noteHtml = item.note ? `<p class="text-sm italic text-red-600">Nota: ${item.note}</p>` : '';
                return `
                    <div class="flex items-center justify-between border-t pt-2 mt-2">
                        <div class="flex-1">
                            <p class="text-sm font-medium">${item.tableName} - x${item.quantity}</p>
                            ${noteHtml}
                        </div>
                        <button onclick="window.completeOrderItem('${item.tableId}', '${item.userId}', '${item.cartItemId}')" class="btn-success p-2 rounded-full transition hover:opacity-90">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                        </button>
                    </div>
                `;
            }).join('');
            
            return `<div class="glass-card p-4">
                        <div class="mb-2">
                            <p class="font-bold text-lg text-gray-800">${dishName} <span class="text-base font-medium text-gold-accent">(Totale: x${totalQuantity})</span></p>
                        </div>
                        ${itemsHtml}
                    </div>`;
        }
        function createActiveOrderCard(item) {
            const noteHtml = item.note ? `<p class="text-sm italic mt-1 text-red-600">Nota: ${item.note}</p>` : '';
            return `<div class="glass-card p-4 flex items-center gap-4" data-order-id="${item.cartItemId}">
                        <div class="flex-1">
                            <p class="font-semibold text-lg text-gray-800">${item.name} <span class="text-base font-medium">x${item.quantity}</span></p>
                            <p class="text-sm font-medium text-gold-accent">${item.tableName}</p>
                            ${noteHtml}
                        </div>
                        <button onclick="window.completeOrderItem('${item.tableId}', '${item.userId}', '${item.cartItemId}')" class="btn-success p-3 rounded-full transition hover:opacity-90 z-20 relative">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                        </button>
                    </div>`;
        }
        function createCompletedOrderCard(item) {
            return `<div class="glass-card p-3 rounded-lg flex justify-between items-center">
                        <div>
                            <p class="font-medium text-gray-700">${item.name} x${item.quantity}</p>
                            <p class="text-xs text-gray-500">${item.tableName}</p>
                        </div>
                        <button onclick="window.undoCompleteOrderItem('${item.tableId}', '${item.userId}', '${item.cartItemId}')" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-1 px-2 rounded-md">Annulla</button>
                    </div>`;
        }
        window.completeOrderItem = async (tableId, userId, cartItemId) => {
            try {
                console.log('Completando ordine:', { tableId, userId, cartItemId });
                
                // Rimuovi immediatamente l'elemento dalla vista per feedback immediato
                const orderElement = document.querySelector(`[data-order-id="${cartItemId}"]`);
                if (orderElement) {
                    orderElement.style.transition = 'all 0.3s ease-out';
                    orderElement.style.transform = 'translateX(100%)';
                    orderElement.style.opacity = '0';
                    setTimeout(() => {
                        orderElement.style.display = 'none';
                    }, 300);
                }
                const tableRef = doc(db, `ristoranti/${docId}/fixedTables`, tableId);
                
                await runTransaction(db, async (transaction) => {
                    const tableDoc = await transaction.get(tableRef);
                    if (!tableDoc.exists()) throw new Error("Tavolo non trovato!");
                    
                    const data = tableDoc.data();
                    const userOrders = (data.orders || {})[userId] || [];
                    const itemIndex = userOrders.findIndex(o => o.cartItemId === cartItemId);
                    
                    if (itemIndex === -1) {
                        console.log('Ordine non trovato negli ordini attivi, potrebbe essere già stato completato.');
                        return; // Esce se l'ordine non è più lì
                    }
                    
                    const [itemToComplete] = userOrders.splice(itemIndex, 1);
                    
                    const completedItem = { 
                        ...itemToComplete, 
                        completedAt: serverTimestamp(),
                        completedAtTimestamp: serverTimestamp() // Usa il timestamp del server per coerenza
                    }; 
                    
                    const newHistory = [...(data.orderHistory || []), completedItem];
                    const newOrders = { ...data.orders, [userId]: userOrders };
                    if (userOrders.length === 0) delete newOrders[userId];
                    
                    transaction.update(tableRef, { orders: newOrders, orderHistory: newHistory });
                });

                // Non aggiorniamo più la cache locale manualmente
                // Il listener di Firestore aggiornerà automaticamente la vista
                // quando la transazione sarà completata
                
                showToast('Ordine completato!', 'success');
            } catch (err) {
                console.error('Errore nel completare l\'ordine:', err);
                handleError(err, "Errore nel completare l'ordine.");
            }
        };
        window.undoCompleteOrderItem = async (tableId, userId, cartItemId) => {
            const tableRef = doc(db, `ristoranti/${docId}/fixedTables`, tableId);
            runTransaction(db, async (transaction) => {
                const tableDoc = await transaction.get(tableRef);
                if (!tableDoc.exists()) throw "Tavolo non trovato!";
                const data = tableDoc.data();
                const history = data.orderHistory || [];
                const itemIndex = history.findIndex(i => i.cartItemId === cartItemId);
                if (itemIndex === -1) return;
                const [itemToUndo] = history.splice(itemIndex, 1);
                delete itemToUndo.completedAt;
                const userOrders = (data.orders || {})[userId] || [];
                userOrders.push(itemToUndo);
                transaction.update(tableRef, { orderHistory: history, orders: { ...data.orders, [userId]: userOrders } });
                // Il listener di Firestore gestirà l'aggiornamento automatico
            }).then(() => {
                // Ricarica la lista degli ordini - Rimosso per affidarsi al listener
            }).catch(err => handleError(err, "Errore nell'annullare l'ordine."));
        };
        function renderTablesGrid(tables) {
            const tablesGrid = document.getElementById('tables-grid');
            tablesGrid.innerHTML = '';
            tables.sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric: true})).forEach(table => {
                tablesGrid.appendChild(createTableCard(table));
            });
        }
        function createTableCard(table) {
            const card = document.createElement('div');
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            card.className = `relative overflow-hidden rounded-2xl transition-all duration-300 transform hover:-translate-y-1 hover:shadow-2xl ${
                table.status === 'attivo' 
                    ? 'bg-gradient-to-br from-emerald-50 to-green-50 border-2 border-emerald-200' 
                    : 'bg-white border-2 border-gray-200'
            } ${isDark ? 'dark-table-card' : ''}`;

            // Status indicator e animazione (unica dichiarazione corretta)
            const statusColor = table.status === 'attivo'
                ? 'bg-emerald-500 shadow-emerald-500/50'
                : 'bg-gray-400';
            const pulseAnimation = table.status === 'attivo' ? 'animate-pulse' : '';

            // Definisci l'overlay (oppure lascialo vuoto)
            const gradientOverlay = '';

            // Delete button
            const deleteButton = `
                <button onclick="window.deleteFixedTable('${table.id}', '${table.name}')" 
                    class="absolute top-4 left-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300 text-red-500 hover:text-red-700 z-10">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            `;

            // Table header
            const tableHeader = `
                <div class="${gradientOverlay} absolute inset-0"></div>
                <div class="relative p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-2xl font-bold text-gray-800">${window.escapeHtml(table.name)}</h3>
                        <div class="flex items-center gap-2">
                            <div class="relative">
                                <div class="${statusColor} ${pulseAnimation} w-3 h-3 rounded-full shadow-lg"></div>
                                ${table.status === 'attivo' ? '<div class="absolute inset-0 bg-emerald-400 rounded-full animate-ping opacity-75"></div>' : ''}
                            </div>
                            <span class="text-xs font-medium ${table.status === 'attivo' ? 'text-emerald-700' : 'text-gray-600'}">
                                ${table.status === 'attivo' ? 'Attivo' : 'Libero'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            

            
            let detailsHtml = '';
            if (table.status === 'attivo') {
                detailsHtml = `
                    <div class="px-6 pb-3">
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 mb-3 border border-blue-100/50 backdrop-blur">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs font-medium text-blue-600 mb-1">PIN di accesso</p>
                                    <p class="text-2xl font-bold font-mono text-blue-800 tracking-wider">${table.sessionPin}</p>
                                </div>
                                <div class="w-10 h-10 bg-blue-500/10 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }
            
            let buttonsHtml = '';
            let billHtml = '';
            
            if (table.status === 'attivo') {
                const totalBill = calculateBill(table, restaurantSettings);
                if (totalBill > 0 || table.guests > 0) {
                    billHtml = `
                        <div class="px-6 pb-3">
                            <div class="relative overflow-hidden bg-gradient-to-br from-emerald-50 via-green-50 to-teal-50 rounded-xl p-5 border border-emerald-100/50">
                                <div class="absolute top-0 right-0 w-32 h-32 bg-emerald-500/10 rounded-full blur-3xl"></div>
                                <div class="relative">
                                    <p class="text-xs font-medium text-emerald-700 mb-2">Totale Conto</p>
                                    <div class="flex items-baseline gap-1">
                                        <span class="text-3xl font-bold text-emerald-800">€${totalBill.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }
                
                buttonsHtml = `
                    <div class="space-y-3 pt-4 border-t border-gray-100">
                        <button onclick='window.showBillDetails("${table.id}")' class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium py-2.5 px-4 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-200 shadow-sm">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Dettaglio Conto
                        </button>
                        
                        <button onclick='window.showQrCode("${table.id}", ${JSON.stringify(table.name)})' class="w-full bg-gradient-to-r from-gray-500 to-gray-600 text-white font-medium py-2.5 px-4 rounded-lg hover:from-gray-600 hover:to-gray-700 transition-all duration-200 shadow-sm">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V6a1 1 0 00-1-1H5a1 1 0 00-1 1v1a1 1 0 001 1zm12 0h2a1 1 0 001-1V6a1 1 0 00-1-1h-2a1 1 0 00-1 1v1a1 1 0 001 1zM5 20h2a1 1 0 001-1v-1a1 1 0 00-1-1H5a1 1 0 00-1 1v1a1 1 0 001 1z"></path>
                            </svg>
                            QR Code
                        </button>
                    </div>`;
            } else {
                buttonsHtml = `
                    <div class="pt-4">
                        <button onclick="window.activateTable('${table.id}')" class="w-full bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-medium py-3 px-4 rounded-lg hover:from-emerald-600 hover:to-emerald-700 transition-all duration-200 shadow-sm">
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Attiva Tavolo
                        </button>
                    </div>`;
            }
            
            // Ricostruiamo il contenuto della card
            const totalBill = table.status === 'attivo' ? calculateBill(table, restaurantSettings) : 0;
            
            card.innerHTML = `
                <div class="group h-full flex flex-col">
                    <!-- Delete button -->
                    <button onclick="window.deleteFixedTable('${table.id}', '${window.escapeHtml(table.name)}')" 
                        class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300 p-2 rounded-full bg-red-50 text-red-500 hover:bg-red-100 z-10">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                    
                    <!-- Header -->
                    <div class="p-5 pb-3">
                        <div class="flex items-center justify-between">
                            <h3 class="text-xl font-bold ${isDark ? 'text-gray-100' : 'text-gray-800'}">${window.escapeHtml(table.name)}</h3>
                            <div class="flex items-center gap-2">
                                <div class="relative">
                                    <div class="w-3 h-3 rounded-full ${statusColor} ${pulseAnimation}"></div>
                                    ${table.status === 'attivo' ? '<div class="absolute inset-0 bg-emerald-400 rounded-full animate-ping opacity-75"></div>' : ''}
                                </div>
                                <span class="text-xs font-medium ${table.status === 'attivo' ? 'text-emerald-700' : 'text-gray-600'}">
                                    ${table.status === 'attivo' ? 'Attivo' : 'Libero'}
                                </span>
                            </div>
                        </div>
                        
                        ${table.status === 'attivo' && table.guests > 0 ? `
                            <p class="text-sm text-gray-600 mt-1">${table.guests} ospiti</p>
                        ` : ''}
                    </div>
                    
                    <!-- Content -->
                    <div class="flex-1 px-5">
                        ${table.status === 'attivo' ? `
                            <!-- PIN -->
                            <div class="bg-blue-50 rounded-lg p-3 mb-3 ${isDark ? 'bg-blue-900/30' : ''}">
                                <p class="text-xs text-blue-600 mb-1">PIN</p>
                                <p class="text-lg font-mono font-bold text-blue-800">${table.sessionPin}</p>
                            </div>
                            
                            <!-- Conto -->
                            ${totalBill > 0 ? `
                                <div class="bg-emerald-50 rounded-lg p-3 mb-3 ${isDark ? 'bg-emerald-900/30' : ''}">
                                    <p class="text-xs text-emerald-600 mb-1">Totale</p>
                                    <p class="text-2xl font-bold text-emerald-800">€${totalBill.toFixed(2)}</p>
                                </div>
                            ` : ''}
                        ` : ''}
                    </div>
                    
                    <!-- Actions -->
                    <div class="p-5 pt-3 mt-auto">
                        ${table.status === 'attivo' ? `
                            <div class="space-y-2">
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="window.showBillDetails('${table.id}')" 
                                        class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 transition text-sm font-medium">
                                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Conto
                                    </button>
                                    <button onclick="window.showQrCode('${table.id}', '${window.escapeHtml(table.name)}')" 
                                        class="bg-gray-500 text-white px-3 py-2 rounded-lg hover:bg-gray-600 transition text-sm font-medium">
                                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V6a1 1 0 00-1-1H5a1 1 0 00-1 1v1a1 1 0 001 1zm12 0h2a1 1 0 001-1V6a1 1 0 00-1-1h-2a1 1 0 00-1 1v1a1 1 0 001 1zM5 20h2a1 1 0 001-1v-1a1 1 0 00-1-1H5a1 1 0 00-1 1v1a1 1 0 001 1z"></path>
                                        </svg>
                                        QR
                                    </button>
                                </div>
                            </div>
                        ` : `
                            <button onclick="window.activateTable('${table.id}')" 
                                class="w-full bg-emerald-500 text-white py-3 px-4 rounded-lg hover:bg-emerald-600 transition font-medium">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Attiva Tavolo
                            </button>
                        `}
                    </div>
                </div>
            `;
            
            return card;
        }

        window.deleteFixedTable = async (tableId, tableName) => {
            if (!confirm(`Sei sicuro di voler eliminare definitivamente il tavolo "${tableName}"?`)) return;
            try {
                await deleteDoc(doc(db, `ristoranti/${docId}/fixedTables`, tableId));
                showToast("Tavolo eliminato.", "success");
            } catch (error) {
                handleError(error, "Errore durante l'eliminazione.");
            }
        };
        window.activateTable = async (tableId) => {
            let numGuests = 0;
            if (restaurantSettings.ayce?.enabled || restaurantSettings.coperto?.enabled) {
                const guestsStr = prompt("Quante persone si siedono al tavolo?");
                if (guestsStr === null) return;
                numGuests = parseInt(guestsStr, 10);
                if (isNaN(numGuests) || numGuests <= 0) return showToast("Numero di persone non valido.", "error");
            }
            const pin = String(Math.floor(1000 + Math.random() * 9000));
            try {
                await updateDoc(doc(db, `ristoranti/${docId}/fixedTables`, tableId), { status: 'attivo', sessionPin: pin, cart: [], orders: {}, orderHistory: [], paidAt: null, guests: numGuests, ordersSentCount: 0 });
            } catch (error) {
                handleError(error, "Errore durante l'attivazione.");
            }
        };
        window.closeTableSession = async (tableId, wasPaid) => {
            const tableRef = doc(db, `ristoranti/${docId}/fixedTables`, tableId);
            try {
                const tableDoc = await getDoc(tableRef);
                if (!tableDoc.exists()) throw "Tavolo non trovato.";
                const data = tableDoc.data();
                if (wasPaid && (calculateBill(data, restaurantSettings) > 0 || data.guests > 0)) {
                    await addDoc(collection(db, `ristoranti/${docId}/historicSessions`), {
                        tableName: data.name,
                        paidAt: serverTimestamp(),
                        orders: [...Object.values(data.orders || {}).flat(), ...(data.orderHistory || [])],
                        totalAmount: calculateBill(data, restaurantSettings),
                        guests: data.guests || 0,
                    });
                }
                await updateDoc(tableRef, { status: 'disponibile', sessionPin: null, cart: [], orders: {}, orderHistory: [], paidAt: null, guests: 0, ordersSentCount: 0 });
                showToast(`Sessione tavolo chiusa.`, "success");
            } catch (error) {
                handleError(error, "Errore nella chiusura della sessione.");
            }
        };
        window.showQrCode = async (tableId, tableName) => {
            const modal = document.getElementById('qr-code-modal');
            const container = document.getElementById('qr-code-container');
            const downloadLink = document.getElementById('qr-download-link');
            document.getElementById('qr-modal-title').textContent = `QR Code per ${tableName}`;
            container.innerHTML = '<div class="animate-pulse bg-gray-300 w-48 h-48 rounded"></div>';
            modal.classList.remove('hidden');
            
            // Use stable table ID for QR code generation instead of changeable table name
            const path = window.location.pathname;
            const basePath = path.substring(0, path.lastIndexOf('/'));
            const clientUrl = `${window.location.origin}${basePath}/index.html?id=${restaurantId}&tableId=${encodeURIComponent(tableId)}`;
            
            try {
                const response = await fetch(`${backendUrl}/generate-qr`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: clientUrl })
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to generate QR code');
                }
                const { qrCode } = await response.json();
                container.innerHTML = `<img src="${qrCode}" alt="QR Code per ${tableName}" class="w-48 h-48">`;
                downloadLink.href = qrCode;
                downloadLink.download = `qr-code-table-${tableId}.png`;
                
                // Show success message
                showToast('QR Code generato con successo!', 'success');
            } catch(e) {
                console.error('QR Code generation error:', e);
                handleError(e, "Errore generazione QR Code.");
                container.innerHTML = `
                    <div class="text-center text-red-400 p-4">
                        <p>Errore generazione QR Code</p>
                        <button onclick="window.showQrCode('${tableId}', '${tableName}')" 
                                class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                            Riprova
                        </button>
                    </div>`;
            }
        };
        let currentBillTableId = null; // Store current table ID for bill actions
        
        window.showBillDetails = (tableId) => {
            const table = allTablesData.find(t => t.id === tableId);
            if (!table) return;
            
            currentBillTableId = tableId; // Store for later use
            const modal = document.getElementById('bill-details-modal');
            const modalTitle = modal.querySelector('#bill-modal-title');
            const modalContent = modal.querySelector('#bill-modal-content');
            const modalTotal = modal.querySelector('#bill-total-amount');
            modalTitle.textContent = `Dettaglio Conto: ${table.name}`;
            let contentHtml = '';
            const allItems = [...Object.values(table.orders || {}).flat(), ...(table.orderHistory || [])];
            if (restaurantSettings.ayce?.enabled && table.guests > 0) {
                contentHtml += `<div class="p-2 bg-blue-100 rounded-md flex justify-between items-center"><p class="font-bold">Menù AYCE x${table.guests}</p><p class="font-bold">€${(restaurantSettings.ayce.price * table.guests).toFixed(2)}</p></div>`;
                const extraItems = allItems.filter(item => item.isExtraCharge);
                if (extraItems.length > 0) {
                     contentHtml += `<h4 class="font-semibold text-lg border-b border-gray-200 pb-1 mb-2 mt-4">Extra</h4>`;
                     extraItems.forEach(item => contentHtml += `<div class="p-2 flex justify-between items-center"><p>${item.name} x${item.quantity}</p><p class="font-semibold">€${((item.price || 0) * item.quantity).toFixed(2)}</p></div>`);
                }
            } else {
                allItems.forEach(item => contentHtml += `<div class="p-2 flex justify-between items-center"><p>${item.name} x${item.quantity}</p><p class="font-semibold">€${((item.price || 0) * item.quantity).toFixed(2)}</p></div>`);
            }
            if (restaurantSettings.coperto?.enabled && table.guests > 0) {
                contentHtml += `<div class="p-2 bg-yellow-100 rounded-md mt-4 flex justify-between items-center"><p class="font-bold">Coperto x${table.guests}</p><p class="font-bold">€${(restaurantSettings.coperto.price * table.guests).toFixed(2)}</p></div>`;
            }
            modalContent.innerHTML = contentHtml || '<p class="text-center text-gray-500">Nessun ordine.</p>';
            modalTotal.textContent = `€${calculateBill(table, restaurantSettings).toFixed(2)}`;
            modal.classList.remove('hidden');
        };
        
        // New function to handle closing table session from bill modal
        window.closeBillAndSession = async (wasPaid) => {
            if (!currentBillTableId) {
                showToast('Errore: nessun tavolo selezionato', 'error');
                return;
            }
            
            // Close the bill modal first
            document.getElementById('bill-details-modal').classList.add('hidden');
            
            // Call the existing closeTableSession function
            await window.closeTableSession(currentBillTableId, wasPaid);
            
            // Reset the current table ID
            currentBillTableId = null;
        };
        // Migration function to add order field to existing dishes
        async function migrateDishOrdering() {
            try {
                const menuRef = collection(db, `ristoranti/${docId}/menu`);
                const snapshot = await getDocs(menuRef);
                
                const batch = writeBatch(db);
                let needsUpdate = false;
                
                snapshot.docs.forEach((doc, index) => {
                    const data = doc.data();
                    if (data.order === undefined) {
                        batch.update(doc.ref, { order: index });
                        needsUpdate = true;
                    }
                });
                
                if (needsUpdate) {
                    await batch.commit();
                    console.log('Migrated dish ordering successfully');
                }
            } catch (error) {
                console.error('Error migrating dish ordering:', error);
            }
        }
        
        function listenToMenu() {
            onSnapshot(query(collection(db, `ristoranti/${docId}/menu`), orderBy("order")), (snapshot) => {
                menuCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMenuList();
            }, (error) => {
                console.error("Error in menu listener:", error);
                // Fallback to ordering by name if order field doesn't exist yet
                onSnapshot(query(collection(db, `ristoranti/${docId}/menu`), orderBy("name")), (snapshot) => {
                    menuCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderMenuList();
                });
            });
        }
        function renderMenuList(searchTerm = '') {
             const menuListContainer = document.getElementById('menu-list');
             menuListContainer.innerHTML = '';
             
             if (menuCache.length === 0) {
                menuListContainer.innerHTML = '<p class="text-center text-gray-600">Nessun piatto nel menù.</p>';
                return;
            }

            let filteredDishes = menuCache;
            if (searchTerm) {
                const lowerSearchTerm = searchTerm.toLowerCase();
                filteredDishes = menuCache.filter(dish => 
                    dish.name.toLowerCase().includes(lowerSearchTerm) ||
                    dish.description.toLowerCase().includes(lowerSearchTerm) ||
                    dish.category.toLowerCase().includes(lowerSearchTerm)
                );
            }

            const dishesGroupedByCategory = {};
            filteredDishes.forEach(dish => {
                const category = dish.category || 'Altro';
                if (!dishesGroupedByCategory[category]) {
                    dishesGroupedByCategory[category] = [];
                }
                dishesGroupedByCategory[category].push(dish);
            });

            const sortedCategories = categoriesCache.map(cat => cat.name).filter(catName => dishesGroupedByCategory[catName]);
            const otherCategories = Object.keys(dishesGroupedByCategory).filter(catName => !sortedCategories.includes(catName));
            
            [...sortedCategories, ...otherCategories].forEach(categoryName => {
                const categoryDishes = dishesGroupedByCategory[categoryName];
                if (categoryDishes && categoryDishes.length > 0) {
                    menuListContainer.insertAdjacentHTML('beforeend', `
                        <div class="mb-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3 pb-2 border-b border-gray-200" style="font-family: 'Playfair Display', serif;">${categoryName}</h4>
                            <div class="space-y-3">
                                ${categoryDishes.map(dish => createDishCard(dish)).join('')}
                            </div>
                        </div>
                    `);
                }
            });

            if (menuListContainer.innerHTML === '') {
                menuListContainer.innerHTML = '<p class="text-center text-gray-600">Nessun piatto trovato.</p>';
            }
        }
        function createDishCard(dish) {
            const { name = 'N/D', description = '', category = 'N/A', price = 0, isAvailable = true, photoUrl, isExtraCharge = false, allergens = [] } = dish;
            const allergenHtml = allergens.length > 0 ? `<div class="flex flex-wrap gap-2 mt-2">${allergens.map(a => `<span class="allergen-tag">${a}</span>`).join('')}</div>` : '';
            const extraChargeBadge = isExtraCharge && restaurantSettings.ayce?.enabled ? `<span class="text-xs font-semibold text-white bg-red-500 px-2 py-0.5 rounded-full ml-2">EXTRA</span>` : '';
            const availabilityClass = isAvailable ? '' : 'opacity-50';
            return `<div class="glass-card p-4 flex items-start gap-4 ${availabilityClass}">
                        <img src="${photoUrl || 'https://placehold.co/100x100/e2e8f0/475569?text=Piatto'}" alt="${name}" class="w-20 h-20 object-cover rounded-lg flex-shrink-0">
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-lg truncate text-gray-800">${name}${extraChargeBadge}</p>
                            <p class="text-sm text-gray-600 mt-1 truncate">${description}</p>
                            ${allergenHtml}
                            <div class="flex items-center gap-x-4 mt-2 text-sm">
                                <p class="font-semibold text-base text-gold-accent">€${(price || 0).toFixed(2)}</p>
                                <p class="text-gray-600">Cat: <span class="font-medium text-gray-800">${category}</span></p>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row items-center gap-1">
                            <button onclick='window.toggleAvailability("${dish.id}", ${isAvailable})' class="p-2 rounded-full hover:bg-gray-100" title="${isAvailable ? 'Nascondi piatto' : 'Mostra piatto'}">
                                <svg class="w-5 h-5 ${isAvailable ? 'text-green-600' : 'text-gray-400'}" fill="currentColor" viewBox="0 0 20 20">
                                    ${isAvailable ? 
                                        '<path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>' :
                                        '<path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2.003 2.003 0 012.45 2.45l1.514 1.514a4 4 0 00-5.478-5.478z" clip-rule="evenodd"/><path d="M12.454 16.697L9.75 13.992a4 4 0 01-3.742-3.741L2.335 6.578A9.98 9.98 0 00.458 10c1.274 4.057 5.065 7 9.542 7 .847 0 1.669-.105 2.454-.303z"/>'
                                    }
                                </svg>
                            </button>
                            <button onclick='window.openEditDishModal("${dish.id}")' class="p-2 rounded-full hover:bg-gray-100">✏️</button>
                            <button onclick='window.deleteDish("${dish.id}")' class="p-2 rounded-full hover:bg-red-50">🗑️</button>
                        </div>
                    </div>`;
        }
        window.openEditDishModal = (dishId) => {
            const dish = menuCache.find(d => d.id === dishId);
            if (!dish) return handleError(null, "Piatto non trovato.");
            const modal = document.getElementById('edit-dish-modal');
            const form = document.getElementById('edit-dish-form');
            form.dishId.value = dishId;
            form.name.value = dish.name || '';
            form.description.value = dish.description || '';
            form.price.value = dish.price || 0;
            const categorySelect = form.querySelector('#edit-dish-category');
            categorySelect.innerHTML = document.getElementById('dish-category').innerHTML;
            categorySelect.value = dish.category || '';
            form.allergens.value = (dish.allergens || []).join(', ');
            form.isExtraCharge.checked = dish.isExtraCharge || false;
            modal.classList.remove('hidden');
        };
        window.handleUpdateDish = async (e) => {
            e.preventDefault();
            const form = e.target;
            const dishId = form.dishId.value;
            const formData = new FormData(form);
            formData.set('isExtraCharge', form.isExtraCharge.checked ? 'true' : 'false');
            formData.set('allergens', JSON.stringify((form.allergens.value || "").split(',').map(a => a.trim()).filter(Boolean)));
            try {
                const response = await fetch(`${backendUrl}/update-dish/${docId}/${dishId}`, { method: 'POST', body: formData });
                if (!response.ok) throw new Error((await response.json()).error);
                showToast("Piatto aggiornato!", "success");
                document.getElementById('edit-dish-modal').classList.add('hidden');
            } catch (error) {
                handleError(error, error.message);
            }
        };
        window.addDish = async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            formData.set('isExtraCharge', form.isExtraCharge.checked ? 'true' : 'false');
            formData.set('allergens', JSON.stringify((form.allergens.value || "").split(',').map(a => a.trim()).filter(Boolean)));
            try {
                const response = await fetch(`${backendUrl}/add-dish/${docId}`, { method: 'POST', body: formData });
                if (!response.ok) throw new Error((await response.json()).error);
                showToast("Piatto aggiunto!", "success");
                form.reset();
            } catch (error) {
                handleError(error, error.message);
            }
        };
        window.deleteDish = async (dishId) => {
            if (!confirm("Sei sicuro di voler eliminare questo piatto?")) return;
            try {
                await deleteDoc(doc(db, `ristoranti/${docId}/menu`, dishId));
                showToast("Piatto eliminato.", "success");
            } catch (error) {
                handleError(error, "Errore eliminazione piatto.");
            }
        };
        window.toggleAvailability = async (dishId, currentStatus) => {
            try {
                await updateDoc(doc(db, `ristoranti/${docId}/menu`, dishId), { isAvailable: !currentStatus });
                showToast("Disponibilità aggiornata.", "info");
            } catch (error) {
                handleError(error, "Errore aggiornamento disponibilità.");
            }
        };
        function listenToCategories() {
            onSnapshot(query(collection(db, `ristoranti/${docId}/menuCategories`), orderBy("order")), (snapshot) => {
                categoriesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const addCatSelect = document.getElementById('dish-category');
                addCatSelect.innerHTML = '<option value="">Seleziona Categoria</option>';
                categoriesCache.forEach(cat => addCatSelect.innerHTML += `<option value="${cat.name}">${cat.name}</option>`);
                const catList = document.getElementById('category-list');
                catList.innerHTML = '';
                categoriesCache.forEach((cat, index) => {
                    const catDiv = document.createElement('div');
                    catDiv.className = 'flex justify-between items-center bg-white border border-gray-200 p-3 rounded-lg shadow-sm hover:shadow-md transition-shadow';
                    catDiv.dataset.categoryId = cat.id;
                    catDiv.dataset.categoryIndex = index;
                    catDiv.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="text-gray-800 font-medium">${cat.name}</span>
                        </div>
                        <button onclick='window.deleteCategory("${cat.id}")' class="text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    `;
                    
                    catList.appendChild(catDiv);
                });
                
                // Render category toggles for analytics
                renderCategoryToggles();
            });
        }
        
        function renderCategoryToggles() {
            const container = document.getElementById('category-toggles');
            if (!container) return;
            
            // Initialize all categories as selected if none are selected
            if (selectedCategories.size === 0) {
                categoriesCache.forEach(cat => selectedCategories.add(cat.name));
            }
            
            container.innerHTML = '';
            categoriesCache.forEach(category => {
                const isSelected = selectedCategories.has(category.name);
                const toggle = document.createElement('button');
                toggle.className = `px-3 py-1.5 text-sm font-medium rounded-full border-2 transition-all ${
                    isSelected 
                        ? 'bg-[#C6A969] text-white border-[#C6A969] shadow-md' 
                        : 'bg-gray-100 text-gray-700 border-gray-300 hover:bg-gray-200 hover:border-gray-400'
                }`;
                toggle.textContent = category.name;
                toggle.onclick = () => toggleCategory(category.name);
                container.appendChild(toggle);
            });
        }
        
        function toggleCategory(categoryName) {
            if (selectedCategories.has(categoryName)) {
                selectedCategories.delete(categoryName);
            } else {
                selectedCategories.add(categoryName);
            }
            renderCategoryToggles();
            // Update only the pie chart instead of refreshing all analytics
            updatePieChartOnly();
        }
        
        // Function to update only the pie chart when categories are toggled
        async function updatePieChartOnly() {
            try {
                // Get current date range from active button
                const activeBtn = document.querySelector('#analitiche .tab-btn.active');
                if (!activeBtn) return;
                
                const daysBack = parseInt(activeBtn.dataset.days) || 0;
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - daysBack);
                startDate.setHours(0,0,0,0);
                endDate.setHours(23,59,59,999);
                
                // Fetch analytics data
                const response = await fetch(`${backendUrl}/analytics/${docId}?startDate=${startDate.toISOString()}&endDate=${endDate.toISOString()}`);
                if (!response.ok) throw new Error('Failed to fetch analytics');
                const data = await response.json();
                
                // Update only the pie chart
                const isDark = document.documentElement.hasAttribute('data-theme');
                const chartTextColor = isDark ? '#e5e7eb' : '#666666';
                
                const pieOptions = { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { 
                            position: 'right', 
                            labels: { 
                                color: chartTextColor,
                                font: { size: 12 }
                            } 
                        } 
                    } 
                };
                
                // Destroy existing pie chart if it exists
                if (dishesPieChartInstance) dishesPieChartInstance.destroy();
                
                // Filter dishes by selected categories and take top 10
                const filteredDishes = data.topDishes.filter(dish => {
                    const menuDish = menuCache.find(m => m.name === dish.name);
                    const dishCategory = menuDish ? menuDish.category : 'Altri';
                    return selectedCategories.has(dishCategory);
                }).slice(0, 10); // Show top 10 dishes
                
                if (filteredDishes.length > 0) {
                    const chartCanvas = document.getElementById('dishesPieChart');
                    if (chartCanvas) {
                        // Function to generate dynamic colors
                        const generateDynamicColors = (count) => {
                            const baseColors = [
                                '#C6A969', '#E8B86D', '#F4D078', '#D4AF37', 
                                '#B8956A', '#9C7A4B', '#FFD700', '#DAA520'
                            ];
                            const colors = [];
                            for (let i = 0; i < count; i++) {
                                if (i < baseColors.length) {
                                    colors.push(baseColors[i]);
                                } else {
                                    const hue = (i * 137.5) % 360;
                                    colors.push(`hsl(${hue}, 65%, 60%)`);
                                }
                            }
                            return colors;
                        };
                        
                        dishesPieChartInstance = new Chart(chartCanvas, {
                            type: 'pie',
                            data: { 
                                labels: filteredDishes.map(d => d.name), 
                                datasets: [{ 
                                    data: filteredDishes.map(d => d.quantity), 
                                    backgroundColor: generateDynamicColors(filteredDishes.length),
                                    borderColor: '#fff',
                                    borderWidth: 2
                                }] 
                            },
                            options: {
                                ...pieOptions,
                                plugins: {
                                    ...pieOptions.plugins,
                                    legend: {
                                        ...pieOptions.plugins.legend,
                                        display: true,
                                        position: 'bottom',
                                        labels: {
                                            color: '#666666',
                                            padding: 15,
                                            font: {
                                                size: 12,
                                                family: "'Inter', sans-serif"
                                            },
                                            generateLabels: function(chart) {
                                                const data = chart.data;
                                                if (data.labels.length && data.datasets.length) {
                                                    return data.labels.map((label, i) => {
                                                        const dataset = data.datasets[0];
                                                        const value = dataset.data[i];
                                                        const total = dataset.data.reduce((a, b) => a + b, 0);
                                                        const percentage = ((value / total) * 100).toFixed(1);
                                                        return {
                                                            text: `${label} (${percentage}%)`,
                                                            fillStyle: dataset.backgroundColor[i],
                                                            hidden: false,
                                                            index: i
                                                        };
                                                    });
                                                }
                                                return [];
                                            }
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.label || '';
                                                const value = context.parsed || 0;
                                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = ((value / total) * 100).toFixed(1);
                                                return `${label}: ${value} (${percentage}%)`;
                                            }
                                        }
                                    }
                                },
                                layout: {
                                    padding: {
                                        top: 20,
                                        bottom: 20
                                    }
                                }
                            }
                        });
                    }
                } else {
                    // Show message when no data available
                    const chartContainer = document.getElementById('dishesPieChart');
                    if (chartContainer && chartContainer.parentElement) {
                        const parent = chartContainer.parentElement;
                        parent.innerHTML = '<div class="flex items-center justify-center h-80"><p class="text-gray-500">Nessun dato disponibile per le categorie selezionate</p></div>';
                        // Restore canvas for next render
                        setTimeout(() => {
                            parent.innerHTML = '<canvas id="dishesPieChart"></canvas>';
                        }, 100);
                    }
                }
            } catch (error) {
                console.error('Error updating pie chart:', error);
            }
        }
        
        window.addCategory = async () => {
            const input = document.getElementById('new-category-name');
            const name = input.value.trim();
            if (!name) return;
            try {
                await addDoc(collection(db, `ristoranti/${docId}/menuCategories`), { name, order: categoriesCache.length });
                showToast("Categoria aggiunta.", "success");
                input.value = '';
            } catch (error) {
                handleError(error, "Errore aggiunta categoria.");
            }
        };
        window.deleteCategory = async (catId) => {
            if (!confirm("Sei sicuro di voler eliminare questa categoria?")) return;
            try {
                await deleteDoc(doc(db, `ristoranti/${docId}/menuCategories`, catId));
                showToast("Categoria eliminata.", "success");
            } catch (error) {
                handleError(error, "Errore eliminazione categoria.");
            }
        };
        
        window.applyCustomDateFilter = () => {
            const startDateVal = document.getElementById('start-date').value;
            const endDateVal = document.getElementById('end-date').value;
            if (!startDateVal || !endDateVal) return showToast("Seleziona entrambe le date.", "error");
            
            document.querySelectorAll('#analitiche .tab-btn').forEach(btn => btn.classList.remove('active'));
            processAnalytics(new Date(startDateVal), new Date(endDateVal));
        };
        window.setAnalyticsDateFilter = (daysBack) => {
            const endDate = new Date();
            const startDate = new Date();
            
            if (daysBack === 0) { 
                startDate.setHours(0, 0, 0, 0);
            } else if (daysBack === 1) { 
                startDate.setDate(startDate.getDate() - 1);
                endDate.setDate(endDate.getDate() - 1);
                startDate.setHours(0, 0, 0, 0);
            } else { 
                startDate.setDate(startDate.getDate() - daysBack + 1);
                startDate.setHours(0, 0, 0, 0);
            }
            endDate.setHours(23, 59, 59, 999);
            
            document.getElementById('start-date').valueAsDate = startDate;
            document.getElementById('end-date').valueAsDate = endDate;
            
            document.querySelectorAll('#analitiche .tab-btn').forEach(btn => btn.classList.remove('active'));
            const buttonIds = {0: 'filter-today', 1: 'filter-yesterday', 7: 'filter-7days', 30: 'filter-30days', 90: 'filter-90days'};
            if(buttonIds[daysBack]) document.getElementById(buttonIds[daysBack])?.classList.add('active');
            
            processAnalytics(startDate, endDate);
        };
        async function processAnalytics(startDate, endDate) {
            try {
                startDate.setHours(0,0,0,0);
                endDate.setHours(23,59,59,999);
                
                const response = await fetch(`${backendUrl}/analytics/${docId}?startDate=${startDate.toISOString()}&endDate=${endDate.toISOString()}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(errorData.error || `Server error: ${response.status}`);
                }
                const data = await response.json();
                
                // Validate data structure
                if (!data || typeof data !== 'object') {
                    throw new Error('Invalid data format received from server');
                }
                
                // Ensure required fields exist with defaults
                const safeData = {
                    totalRevenue: data.totalRevenue || 0,
                    totalSessions: data.totalSessions || 0,
                    dailyRevenue: Array.isArray(data.dailyRevenue) ? data.dailyRevenue : [],
                    dailySessions: Array.isArray(data.dailySessions) ? data.dailySessions : [],
                    topDishes: Array.isArray(data.topDishes) ? data.topDishes : []
                };
                
                document.getElementById('total-revenue').textContent = `€${safeData.totalRevenue.toFixed(2)}`;
                document.getElementById('total-orders-count').textContent = safeData.totalSessions;

                const isDark = document.documentElement.hasAttribute('data-theme');
                const chartTextColor = isDark ? '#e5e7eb' : '#666666';
                const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
                
                const chartOptions = { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: false } 
                    }, 
                    scales: { 
                        x: { 
                            ticks: { color: chartTextColor },
                            grid: { color: gridColor }
                        }, 
                        y: { 
                            ticks: { color: chartTextColor },
                            grid: { color: gridColor }
                        } 
                    } 
                };
                const pieOptions = { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { 
                            position: 'right', 
                            labels: { 
                                color: '#666666',
                                font: { size: 12 }
                            } 
                        } 
                    } 
                };

                if (revenueChartInstance) revenueChartInstance.destroy();
                revenueChartInstance = new Chart(document.getElementById('revenueChart'), {
                    type: 'bar',
                    data: { 
                        labels: safeData.dailyRevenue.map(d => d.date || 'N/A'), 
                        datasets: [{ 
                            label: 'Incasso', 
                            data: safeData.dailyRevenue.map(d => d.revenue || 0), 
                            backgroundColor: '#C6A969',
                            borderColor: '#C6A969',
                            borderWidth: 0
                        }] 
                    },
                    options: chartOptions
                });
                if (ordersChartInstance) ordersChartInstance.destroy();
                ordersChartInstance = new Chart(document.getElementById('ordersChart'), {
                    type: 'line',
                    data: { 
                        labels: safeData.dailySessions.map(d => d.date || 'N/A'), 
                        datasets: [{ 
                            label: 'Conti', 
                            data: safeData.dailySessions.map(d => d.sessions || 0), 
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointBackgroundColor: '#3B82F6',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }] 
                    },
                    options: chartOptions
                });
                // Funzione per generare colori dinamicamente
                function generateDynamicColors(count) {
                    const colors = [];
                    const baseColors = [
                        '#C6A969', '#3B82F6', '#10B981', '#F59E0B',
                        '#EF4444', '#8B5CF6', '#06B6D4', '#84CC16',
                        '#F97316', '#D946EF', '#6366F1', '#14B8A6'
                    ];
                    for (let i = 0; i < count; i++) {
                        if (i < baseColors.length) {
                            colors.push(baseColors[i]);
                        } else {
                            // Genera colori casuali ma leggibili per le categorie extra
                            const hue = (i * 137.508) % 360; // Angolo d'oro per colori distinti
                            const saturation = 70; // Saturazione alta per colori vividi
                            const lightness = 50; // Luminosità media per una buona leggibilità
                            colors.push(`hsl(${hue}, ${saturation}%, ${lightness}%)`);
                        }
                    }
                    return colors;
                }

                if (dishesPieChartInstance) dishesPieChartInstance.destroy();
                
                // Filtra i piatti per categorie selezionate e prendi i top 10
                const filteredDishes = safeData.topDishes.filter(dish => {
                    const menuDish = menuCache.find(m => m.name === dish.name);
                    const dishCategory = menuDish ? menuDish.category : 'Altri';
                    return selectedCategories.has(dishCategory);
                }).slice(0, 10); // Mostra i top 10 piatti
                
                // Only create chart if we have data
                if (filteredDishes.length > 0) {
                    // Ensure canvas element exists
                    const chartCanvas = document.getElementById('dishesPieChart');
                    if (chartCanvas) {
                        dishesPieChartInstance = new Chart(chartCanvas, {
                            type: 'pie',
                            data: { 
                                labels: filteredDishes.map(d => d.name), 
                                datasets: [{ 
                                    data: filteredDishes.map(d => d.quantity), 
                                    backgroundColor: generateDynamicColors(filteredDishes.length),
                                    borderColor: '#fff',
                                    borderWidth: 2
                                }] 
                            },
                            options: {
                                ...pieOptions,
                                plugins: {
                                    ...pieOptions.plugins,
                                    legend: {
                                        ...pieOptions.plugins.legend,
                                        display: true,
                                        position: 'bottom',
                                        labels: {
                                            color: '#666666',
                                            padding: 15,
                                            font: {
                                                size: 12,
                                                family: "'Inter', sans-serif"
                                            },
                                            generateLabels: function(chart) {
                                                const data = chart.data;
                                                if (data.labels.length && data.datasets.length) {
                                                    return data.labels.map((label, i) => {
                                                        const dataset = data.datasets[0];
                                                        const value = dataset.data[i];
                                                        const total = dataset.data.reduce((a, b) => a + b, 0);
                                                        const percentage = ((value / total) * 100).toFixed(1);
                                                        return {
                                                            text: `${label} (${percentage}%)`,
                                                            fillStyle: dataset.backgroundColor[i],
                                                            hidden: false,
                                                            index: i
                                                        };
                                                    });
                                                }
                                                return [];
                                            }
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.label || '';
                                                const value = context.parsed || 0;
                                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = ((value / total) * 100).toFixed(1);
                                                return `${label}: ${value} (${percentage}%)`;
                                            }
                                        }
                                    }
                                },
                                layout: {
                                    padding: {
                                        top: 20,
                                        bottom: 20
                                    }
                                }
                            }
                        });
                    }
                } else {
                    // Show message when no data available
                    const chartContainer = document.getElementById('dishesPieChart');
                    if (chartContainer && chartContainer.parentElement) {
                        const parent = chartContainer.parentElement;
                        parent.innerHTML = '<div class="flex items-center justify-center h-80"><p class="text-gray-500">Nessun dato disponibile per le categorie selezionate</p></div>';
                        // Restore canvas for next render
                        setTimeout(() => {
                            parent.innerHTML = '<canvas id="dishesPieChart"></canvas>';
                        }, 100);
                    }
                }
            } catch(error) {
                console.error("Analytics loading error:", error);
                
                // Show fallback UI for analytics
                document.getElementById('total-revenue').textContent = '€0.00';
                document.getElementById('total-orders-count').textContent = '0';
                
                // Clear existing charts
                if (revenueChartInstance) {
                    revenueChartInstance.destroy();
                    revenueChartInstance = null;
                }
                if (ordersChartInstance) {
                    ordersChartInstance.destroy();
                    ordersChartInstance = null;
                }
                if (dishesPieChartInstance) {
                    dishesPieChartInstance.destroy();
                    dishesPieChartInstance = null;
                }
                
                // Show user-friendly error message with details
                let errorMessage = "Impossibile caricare le statistiche.";
                if (error.message.includes('fetch')) {
                    errorMessage += " Verifica la connessione al server.";
                } else if (error.message.includes('JSON')) {
                    errorMessage += " Errore nel formato dei dati.";
                } else if (error.message.includes('Canvas')) {
                    errorMessage += " Errore nella visualizzazione dei grafici.";
                }
                
                // Display fallback message in chart containers
                const chartContainers = ['revenueChart', 'ordersChart', 'dishesPieChart'];
                chartContainers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container) {
                        const parent = container.parentElement;
                        if (parent) {
                            parent.innerHTML = `
                                <div class="flex flex-col items-center justify-center h-80 p-4">
                                    <div class="text-gray-400 mb-4">
                                        <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                    </div>
                                    <p class="text-gray-500 text-center mb-2">Dati non disponibili</p>
                                    <button onclick="window.setAnalyticsDateFilter(7)" class="px-4 py-2 bg-[var(--gold-accent)] text-white rounded-lg hover:opacity-90 transition-opacity text-sm">
                                        Riprova
                                    </button>
                                </div>
                            `;
                            // Add back canvas element for future attempts
                            setTimeout(() => {
                                const canvas = document.createElement('canvas');
                                canvas.id = containerId;
                                parent.innerHTML = '';
                                parent.appendChild(canvas);
                            }, 5000);
                        }
                    }
                });
                
                handleError(error, errorMessage);
            }
        }
        
        // Modal per aggiungere tavoli
        window.openAddTableModal = () => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Aggiungi Nuovo Tavolo</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome Tavolo</label>
                            <input type="text" id="modal-table-name" placeholder="Es: Tavolo 1, Terrazza 2" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                                Annulla
                            </button>
                            <button onclick="window.addTableFromModal()" 
                                    class="flex-1 px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition-colors">
                                Aggiungi
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Focus sull'input
            setTimeout(() => {
                document.getElementById('modal-table-name').focus();
            }, 100);
        };
        
        window.addTableFromModal = async () => {
            const input = document.getElementById('modal-table-name');
            const name = input.value.trim();
            if (!name) {
                showToast("Il nome del tavolo è obbligatorio.", "error");
                return;
            }
            
            try {
                const tableId = name.toLowerCase().replace(/\s+/g, '-');
                await setDoc(doc(db, `ristoranti/${docId}/fixedTables`, tableId), { 
                    name, 
                    status: 'disponibile', 
                    sessionPin: null, 
                    cart: [], 
                    orders: {}, 
                    orderHistory: [], 
                    guests: 0, 
                    ordersSentCount: 0 
                });
                showToast(`Tavolo "${name}" aggiunto!`, 'success');
                
                // Chiudi il modal
                document.querySelector('.fixed').remove();
            } catch (error) {
                handleError(error, "Errore nell'aggiunta del tavolo.");
            }
        };
        
        // Debug function to check if all elements are properly initialized
        function debugDashboardElements() {
            console.log('=== Dashboard Debug Info ===');
            
            // Check critical elements
            const criticalElements = [
                'sidebar', 'sidebar-overlay', 'mobile-menu-button',
                'view-by-tables', 'view-by-dishes', 'menu-search',
                'add-dish-form', 'edit-dish-form', 'details-form',
                'filter-today', 'filter-yesterday', 'filter-7days',
                'timeline-today-btn', 'timeline-tomorrow-btn'
            ];
            
            criticalElements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`${id}: ${element ? '✓ Found' : '✗ Missing'}`);
            });
            
            // Check if event listeners are attached
            console.log('=== Event Listeners Check ===');
            const testButton = document.getElementById('view-by-tables');
            if (testButton) {
                console.log('view-by-tables click listeners:', testButton.onclick ? 'Has onclick' : 'No onclick');
                console.log('view-by-tables event listeners count:', testButton._listeners ? testButton._listeners.length : 'Unknown');
            }
            
            console.log('=== Dashboard Debug Complete ===');
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            initialize();
            
            // Debug after a short delay to ensure everything is loaded
            setTimeout(debugDashboardElements, 1000);
        });
    </script>
</body>
</html>